(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const n of i)if(n.type==="childList")for(const r of n.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&s(r)}).observe(document,{childList:!0,subtree:!0});function e(i){const n={};return i.integrity&&(n.integrity=i.integrity),i.referrerPolicy&&(n.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?n.credentials="include":i.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function s(i){if(i.ep)return;i.ep=!0;const n=e(i);fetch(i.href,n)}})();const mt=14,gt=12,xt=56,St=2.4;class vt{spawnX;spawnY;width;height;speed;respawnDelaySec;x;y;vx;vy;grounded=!1;facing=-1;alive=!0;respawnTimerSec=0;constructor(t){this.spawnX=t.x,this.spawnY=t.y,this.width=t.w??mt,this.height=t.h??gt,this.speed=t.speed??xt,this.respawnDelaySec=t.respawnDelaySec??St,this.x=this.spawnX,this.y=this.spawnY,this.vx=this.speed*this.facing,this.vy=0}update(t,e,s,i,n){if(!this.alive){this.respawnTimerSec-=t,this.respawnTimerSec<=0&&this.respawn();return}this.grounded&&!this.hasGroundAhead(e)&&this.reverseDirection(),this.vx=this.speed*this.facing,this.x+=this.vx*t;let r=!1;for(const o of e)B(this.getBody(),o,n)&&(r=!0,this.vx>0?this.x=o.x-this.width+n:this.vx<0&&(this.x=o.x+o.w-n));r&&(this.reverseDirection(),this.vx=this.speed*this.facing),this.vy=Math.min(this.vy+s*t,i),this.y+=this.vy*t,this.grounded=!1;for(const o of e)B(this.getBody(),o,n)&&(this.vy>0?(this.y=o.y-this.height+n,this.grounded=!0):this.vy<0&&(this.y=o.y+o.h-n),this.vy=0)}draw(t){this.alive&&(t.save(),t.fillStyle="#8b2e3b",t.fillRect(this.x,this.y,this.width,this.height),t.fillStyle="#f8d7db",this.facing===1?t.fillRect(this.x+this.width-3,this.y+3,2,2):t.fillRect(this.x+1,this.y+3,2,2),t.restore())}kill(){this.alive&&(this.alive=!1,this.respawnTimerSec=this.respawnDelaySec,this.vx=0,this.vy=0)}reset(){this.alive=!0,this.respawnTimerSec=0,this.x=this.spawnX,this.y=this.spawnY,this.facing=-1,this.vx=this.speed*this.facing,this.vy=0,this.grounded=!1}isAlive(){return this.alive}getBody(){return{x:this.x,y:this.y,w:this.width,h:this.height}}hasGroundAhead(t){const e=this.facing===1?this.x+this.width+2:this.x-2,s=this.y+this.height+2;return t.some(i=>{const n=e>=i.x&&e<=i.x+i.w,r=s>=i.y&&s<=i.y+i.h+1;return n&&r})}reverseDirection(){this.facing=this.facing===1?-1:1}respawn(){this.alive=!0,this.respawnTimerSec=0,this.x=this.spawnX,this.y=this.spawnY,this.vx=this.speed*this.facing,this.vy=0,this.grounded=!1}}function B(a,t,e){return a.x+e<t.x+t.w&&a.x+a.w-e>t.x&&a.y+e<t.y+t.h&&a.y+a.h-e>t.y}const v=320,w=180,N=1200,Tt=900,wt=650,q=170,Et=.65,k=1200,Y=700,V=120,U=120,f=.75,j=2,D=3,Ct=1,$=190,At=4,Mt=.5,X=3,Pt=6,A=16,z=6,Dt=.1,bt=28,Rt=34,It=28,Gt=.7,J=.3,_t=-120,Lt=520,Ot=2.5,W=.45,Ht=.2,Ft=.35,Bt=.075,Nt=600,K=30,qt=1.5,Q=16,Z=40,m=[{x:0,y:164,w:320,h:16},{x:52,y:128,w:72,h:10},{x:160,y:102,w:62,h:10},{x:250,y:138,w:56,h:10}],tt={x:78,y:116},et={x:186,y:88,w:8,h:8,collected:!1},d={x:292,y:132,w:18,h:32};class kt{canvas;ctx;input;onGameOver;onLevelComplete;sound;enemy;playerSpriteImage;playerAnimations;playerSpriteReady=!1;currentPlayerAnimation="idle";playerAnimationFrameIndex=0;playerAnimationFrameElapsed=0;lastTick=0;nowMs=0;isRunning=!1;lastGroundedTimeMs=-1/0;lastJumpPressedTimeMs=-1/0;previousJumpHeld=!1;debugEnabled=!1;hearts=D;bonesCollected=0;invincibleTimerSec=0;gameState="playing";elapsedSec=0;playerState="normal";digTimerSec=0;activeDigSpotIndex=null;digSpots=[];bones=[];digParticles=[];digEmitTimerSec=0;goldenToy={...et};hasGoldenToy=!1;gateHintTimerSec=0;player={x:Q,y:Z,w:16,h:16,vx:0,vy:0,facing:1,grounded:!1,animationTime:0};constructor(t,e,s={}){const i=t.getContext("2d");if(!i)throw new Error("2D context unavailable");this.canvas=t,this.ctx=i,this.input=e,this.onGameOver=s.onGameOver,this.onLevelComplete=s.onLevelComplete,this.sound=s.sound,this.enemy=new vt(tt),this.digSpots=this.generateDigSpots("level1");const n=$t();this.playerSpriteImage=n.image,this.playerAnimations=n.animations,this.playerSpriteImage.onload=()=>{this.playerSpriteReady=!0},this.ctx.imageSmoothingEnabled=!1,window.addEventListener("keydown",r=>{r.code==="Backslash"&&(this.debugEnabled=!this.debugEnabled)}),this.resizeCanvas(),window.addEventListener("resize",()=>this.resizeCanvas())}start(){this.isRunning||(this.isRunning=!0,this.lastTick=performance.now(),requestAnimationFrame(t=>this.loop(t)))}restart(){this.hearts=D,this.bonesCollected=0,this.invincibleTimerSec=0,this.gameState="playing",this.lastGroundedTimeMs=-1/0,this.lastJumpPressedTimeMs=-1/0,this.previousJumpHeld=!1,this.elapsedSec=0,this.playerState="normal",this.digTimerSec=0,this.activeDigSpotIndex=null,this.digEmitTimerSec=0,this.player.x=Q,this.player.y=Z,this.player.vx=0,this.player.vy=0,this.player.facing=1,this.player.grounded=!1,this.player.animationTime=0,this.currentPlayerAnimation="idle",this.playerAnimationFrameIndex=0,this.playerAnimationFrameElapsed=0,this.enemy.reset(),this.digSpots=this.generateDigSpots("level1"),this.bones=[],this.digParticles=[],this.goldenToy={...et,collected:!1},this.hasGoldenToy=!1,this.gateHintTimerSec=0}isGameOver(){return this.gameState==="gameOver"}isLevelComplete(){return this.gameState==="levelComplete"}loop(t){if(!this.isRunning)return;const e=Math.min((t-this.lastTick)/1e3,1/30);this.lastTick=t,this.nowMs=t,this.update(e),this.render(),this.input.endFrame(),requestAnimationFrame(s=>this.loop(s))}update(t){if(this.gameState!=="playing")return;const e=this.input.state,s=Number(e.right)-Number(e.left),i=this.player.y+this.player.h;if(this.elapsedSec+=t,this.invincibleTimerSec>0&&(this.invincibleTimerSec=Math.max(0,this.invincibleTimerSec-t)),this.gateHintTimerSec>0&&(this.gateHintTimerSec=Math.max(0,this.gateHintTimerSec-t)),this.playerState==="normal"&&this.input.consumeDigPressed()){const n=this.findDigSpotForPlayer();this.player.grounded&&n!==null&&(this.playerState="digging",this.digTimerSec=Mt,this.activeDigSpotIndex=n,this.player.vx=0)}if(this.player.grounded&&(this.lastGroundedTimeMs=this.nowMs),this.playerState==="normal"){this.input.consumeJumpPressed()&&(this.lastJumpPressedTimeMs=this.nowMs),s<0?this.player.facing=-1:s>0&&(this.player.facing=1);const n=this.player.grounded?Tt:wt;s!==0?this.player.vx+=s*n*t:this.player.grounded&&(this.player.vx=st(this.player.vx,0,k*t)),this.player.vx=it(this.player.vx,-q,q);const r=this.nowMs-this.lastJumpPressedTimeMs<=U,o=this.player.grounded||this.nowMs-this.lastGroundedTimeMs<=V;r&&o&&(this.player.vy=-420,this.player.grounded=!1,this.lastJumpPressedTimeMs=-1/0,this.lastGroundedTimeMs=-1/0,this.sound?.playJump()),this.previousJumpHeld&&!e.jumpHeld&&this.player.vy<0&&(this.player.vy*=Et)}else this.player.grounded&&(this.player.vx=st(this.player.vx,0,k*t)),this.emitDigParticlesWhileDigging(t),this.digTimerSec-=t,this.digTimerSec<=0&&this.finishDig();this.player.vy+=N*t,this.player.vy=Math.min(this.player.vy,Y),this.moveHorizontal(t,e),this.moveVertical(t),this.player.grounded=this.checkGrounded(),this.player.grounded&&(this.lastGroundedTimeMs=this.nowMs),this.enemy.update(t,m,N,Y,f),this.handlePlayerEnemyCollision(i),this.updateBonesAndParticles(t),this.handleGoldenToyAndGate(),this.updatePlayerAnimation(t),this.player.animationTime+=t,this.previousJumpHeld=e.jumpHeld}moveHorizontal(t,e){this.player.x+=this.player.vx*t;for(const s of m)u(this.player,s,f)&&(this.tryStepUp(e)||(this.player.vx>0&&this.player.x+this.player.w>s.x?this.player.x=s.x-this.player.w+f:this.player.vx<0&&(this.player.x=s.x+s.w-f),this.player.vx=0))}moveVertical(t){this.player.y+=this.player.vy*t;for(const e of m)u(this.player,e,f)&&(this.player.vy>0?this.player.y=e.y-this.player.h+f:this.player.vy<0&&(this.player.y=e.y+e.h-f),this.player.vy=0)}tryStepUp(t){const e=t.right&&this.player.vx>0||t.left&&this.player.vx<0;if(!this.player.grounded||!e)return!1;const s={x:this.player.x,y:this.player.y-j,w:this.player.w,h:this.player.h};return m.some(n=>u(s,n,f))?!1:(this.player.y-=j,!0)}handlePlayerEnemyCollision(t){if(!this.enemy.isAlive())return;const e=this.enemy.getBody();if(!u(this.player,e,0))return;const s=this.player.y+this.player.h;if(this.player.vy>0&&t<=e.y+At&&s>=e.y){this.enemy.kill(),this.player.vy=-189,this.player.grounded=!1,this.lastGroundedTimeMs=-1/0,this.sound?.playStomp();return}if(this.invincibleTimerSec>0)return;this.hearts=Math.max(0,this.hearts-1),this.invincibleTimerSec=Ct;const n=this.player.x+this.player.w/2,r=e.x+e.w/2;this.player.vx=n<r?-$:$,this.player.vy=-220,this.player.grounded=!1,this.sound?.playHurt(),this.hearts<=0&&(this.gameState="gameOver",this.onGameOver?.())}handleGoldenToyAndGate(){if(!this.goldenToy.collected&&u(this.player,this.goldenToy,0)&&(this.goldenToy.collected=!0,this.hasGoldenToy=!0,this.sound?.playGoldenToyPickup(),this.sound?.playGateUnlock()),!!u(this.player,d,0)){if(!this.hasGoldenToy){this.gateHintTimerSec=Math.max(this.gateHintTimerSec,qt);return}this.gameState="levelComplete",this.sound?.playLevelComplete(),this.onLevelComplete?.({bonesCollected:this.bonesCollected,heartsRemaining:this.hearts,timeSec:this.elapsedSec})}}updateBonesAndParticles(t){for(const e of this.bones)e.active&&(e.state==="popping"&&(e.popTimerSec+=t,e.vy+=Lt*t,e.y+=e.vy*t,e.popTimerSec<J*.75?e.y=Math.max(e.targetY,e.y):e.y=Math.min(e.settleY,Math.max(e.targetY,e.y)),e.popTimerSec>=J&&(e.state="idle",e.y=e.settleY,e.vy=0)),e.state==="idle"&&u(this.player,e,0)&&(e.active=!1,this.bonesCollected+=1,this.sound?.playBonePickup()));for(let e=this.digParticles.length-1;e>=0;e-=1){const s=this.digParticles[e];if(s.lifeSec-=t,s.lifeSec<=0){this.digParticles.splice(e,1);continue}s.x+=s.vx*t,s.y+=s.vy*t,s.vy+=Nt*t}}finishDig(){if(this.playerState="normal",this.sound?.playDig(),this.activeDigSpotIndex===null)return;const t=this.digSpots[this.activeDigSpotIndex];this.activeDigSpotIndex=null,!(!t||t.dug)&&(t.dug=!0,t.hasBone?this.spawnBoneFromSpot(t):this.spawnEmptyDigPuff(t))}spawnBoneFromSpot(t){const i=t.y+t.h,n=i-4,r=i-12,o=r+Ot;this.bones.push({x:t.x+(t.w-8)/2,y:n,w:8,h:6,active:!0,vy:_t,state:"popping",popTimerSec:0,startY:n,targetY:r,settleY:o})}spawnEmptyDigPuff(t){const e=t.x+t.w/2,s=t.y+1,i=3+Math.floor((t.x+t.y)%4);for(let n=0;n<i;n+=1){const r=n-(i-1)/2;this.pushDigParticle({x:e+r*2,y:s,w:3,h:3,vx:r*16,vy:-45-Math.abs(r)*5,lifeSec:W,maxLifeSec:W})}}emitDigParticlesWhileDigging(t){if(this.activeDigSpotIndex===null)return;const e=this.digSpots[this.activeDigSpotIndex];if(e)for(this.digEmitTimerSec-=t;this.digEmitTimerSec<=0;){this.digEmitTimerSec+=Bt;const s=1+Math.floor(Math.random()*2);for(let i=0;i<s;i+=1){const n=Math.random()<.5?2:3,r=E(Ht,Ft,Math.random());this.pushDigParticle({x:e.x+e.w*(.25+Math.random()*.5),y:e.y+e.h-1,w:n,h:n,vx:E(-40,40,Math.random()),vy:E(-120,-60,Math.random()),lifeSec:r,maxLifeSec:r})}}}pushDigParticle(t){this.digParticles.push(t),this.digParticles.length>K&&this.digParticles.splice(0,this.digParticles.length-K)}findDigSpotForPlayer(){for(let t=0;t<this.digSpots.length;t+=1){const e=this.digSpots[t];if(!e.dug&&u(this.player,e,0))return t}return null}generateDigSpots(t){const e=Vt(),s=at(t),i=X+Math.floor(s()*(Pt-X+1)),n=Math.max(e.x+Math.floor(v*Dt),e.x+bt),r=e.x+e.w-A-2,o=[];let y=0;for(;o.length<i&&y<300;){y+=1;const p=Math.floor(E(n,r,s())),x=p+A/2;if(Math.abs(x-tt.x)<Rt||o.some(S=>Math.abs(x-(S.x+S.w/2))<It))continue;const l=e.y-z,h={x:p,y:l,w:A,h:z,dug:!1,hasBone:s()<Gt,dirtDecor:Ut(`${t}:${p}:${l}`)};Yt(h,m)&&o.push(h)}return o}render(){this.ctx.imageSmoothingEnabled=!1,this.ctx.clearRect(0,0,v,w),this.ctx.fillStyle="#8bd3ff",this.ctx.fillRect(0,0,v,w),this.ctx.fillStyle="#669f5d";for(const t of m)this.ctx.fillRect(t.x,t.y,t.w,t.h);this.drawExitGate(),this.drawGoldenToy(),this.drawDigSpots(),this.drawBones(),this.drawDigParticles(),this.enemy.draw(this.ctx),this.drawPlayer(),this.drawHud(),this.gateHintTimerSec>0&&this.drawGateHint(),this.debugEnabled&&this.drawDebug()}drawExitGate(){const t=this.hasGoldenToy,e=.75+Math.sin(this.nowMs*.01)*.25;this.ctx.fillStyle=t?`rgba(76, 178, 89, ${e.toFixed(3)})`:"#6d5f67",this.ctx.fillRect(d.x,d.y,d.w,d.h),this.ctx.fillStyle=t?"#c8f3ce":"#a99ca4";const s=3;for(let i=0;i<s;i+=1){const n=d.x+3+i*4;this.ctx.fillRect(n,d.y+3,2,d.h-6)}this.ctx.strokeStyle="#283040",this.ctx.strokeRect(d.x,d.y,d.w,d.h)}drawGoldenToy(){if(this.goldenToy.collected)return;const t=1+Math.sin(this.nowMs*.012)*.1,e=this.goldenToy.w*t,s=this.goldenToy.h*t,i=this.goldenToy.x-(e-this.goldenToy.w)/2,n=this.goldenToy.y-(s-this.goldenToy.h)/2;this.ctx.fillStyle="#f5cb42",this.ctx.fillRect(i,n,e,s),this.ctx.fillStyle="#fff2b8",this.ctx.fillRect(i+2,n+2,Math.max(1,e-4),Math.max(1,s-4)),this.ctx.strokeStyle="#a87f18",this.ctx.strokeRect(i,n,e,s)}drawDigSpots(){for(let t=0;t<this.digSpots.length;t+=1){const e=this.digSpots[t],s=this.activeDigSpotIndex===t&&this.playerState==="digging";this.ctx.fillStyle=e.dug?"#8b7657":"#56724a",this.ctx.fillRect(e.x,e.y,e.w,e.h),e.dug?(this.ctx.fillStyle="#3f3c34",this.ctx.fillRect(e.x+2,e.y+2,e.w-4,2),this.drawDugSpotDecor(e)):(this.ctx.fillStyle=s?"#d7c086":"#8ca574",this.ctx.fillRect(e.x+2,e.y+1,2,2),this.ctx.fillRect(e.x+e.w-4,e.y+1,2,2)),this.debugEnabled&&(this.ctx.strokeStyle="rgba(255, 255, 0, 0.8)",this.ctx.strokeRect(e.x,e.y,e.w,e.h))}}drawDugSpotDecor(t){const e=["#7f6948","#6f5b3f","#8d7450"];for(const s of t.dirtDecor){const i=t.x+s.xOffset,n=t.y+s.yOffset,r=s.size,o=s.flipX?-1:1;this.ctx.fillStyle=e[s.shadeIndex%e.length],this.ctx.beginPath(),this.ctx.moveTo(i,n),this.ctx.lineTo(i+o*r,n+1),this.ctx.lineTo(i,n+r),this.ctx.closePath(),this.ctx.fill()}}drawBones(){for(const t of this.bones)t.active&&(this.ctx.fillStyle="#ffffff",this.ctx.fillRect(t.x,t.y,t.w,t.h),this.ctx.strokeStyle="#d8d8d8",this.ctx.strokeRect(t.x,t.y,t.w,t.h))}drawDigParticles(){for(const t of this.digParticles){const e=it(t.lifeSec/t.maxLifeSec,0,1);this.ctx.fillStyle=`rgba(120, 78, 42, ${e.toFixed(3)})`,this.ctx.fillRect(t.x,t.y,t.w,t.h)}}drawPlayer(){this.ctx.save(),this.invincibleTimerSec>0&&Math.floor(this.nowMs/80)%2===0&&(this.ctx.globalAlpha=.35);const t=this.player.x-4,e=this.player.y-8,s=24,i=24;if(this.player.facing===-1?(this.ctx.translate(t+s,e),this.ctx.scale(-1,1)):this.ctx.translate(t,e),this.playerSpriteReady){const n=this.getCurrentPlayerFrame();this.ctx.drawImage(this.playerSpriteImage,n.x,n.y,n.w,n.h,0,0,s,i)}else this.ctx.fillStyle=this.playerState==="digging"?"#3b4659":"#2f4f6f",this.ctx.fillRect(4,8,this.player.w,this.player.h),this.ctx.fillStyle="#ffffff",this.ctx.fillRect(15,12,2,2);this.ctx.restore()}updatePlayerAnimation(t){const e=this.playerState==="digging"?"digging":this.player.grounded?Math.abs(this.player.vx)>18?"run":"idle":"jump";e!==this.currentPlayerAnimation&&(this.currentPlayerAnimation=e,this.playerAnimationFrameIndex=0,this.playerAnimationFrameElapsed=0);const s=this.playerAnimations[this.currentPlayerAnimation];if(!(s.length<=1))for(this.playerAnimationFrameElapsed+=t;this.playerAnimationFrameElapsed>=s[this.playerAnimationFrameIndex].duration;)this.playerAnimationFrameElapsed-=s[this.playerAnimationFrameIndex].duration,this.playerAnimationFrameIndex<s.length-1?this.playerAnimationFrameIndex+=1:this.playerAnimationFrameIndex=0}getCurrentPlayerFrame(){const t=this.playerAnimations[this.currentPlayerAnimation];return t[this.playerAnimationFrameIndex]??t[0]}drawHud(){this.ctx.fillStyle="rgba(12, 24, 40, 0.72)",this.ctx.fillRect(6,6,174,46),this.ctx.font="10px monospace",this.ctx.fillStyle="#f7f3c5",this.ctx.fillText("HP",11,18);for(let t=0;t<D;t+=1){const e=30+t*16,s=t<this.hearts;this.ctx.fillStyle=s?"#da4f5d":"#4b5968",this.ctx.fillRect(e,10,10,10),this.ctx.strokeStyle="#81252f",this.ctx.strokeRect(e,10,10,10)}this.ctx.fillStyle="#f7f3c5",this.ctx.fillText(`Bones: ${this.bonesCollected}`,11,31),this.ctx.fillText(`Toy: ${this.hasGoldenToy?"1/1":"0/1"}`,11,44)}drawGateHint(){this.ctx.fillStyle="rgba(0, 0, 0, 0.6)",this.ctx.fillRect(96,8,128,18),this.ctx.fillStyle="#f9e7b8",this.ctx.font="9px monospace",this.ctx.fillText("Find the Golden Toy",105,20)}drawDebug(){const t=Math.max(0,V-(this.nowMs-this.lastGroundedTimeMs)),e=Math.max(0,U-(this.nowMs-this.lastJumpPressedTimeMs));this.ctx.fillStyle="rgba(0, 0, 0, 0.65)",this.ctx.fillRect(6,56,206,86),this.ctx.fillStyle="#d7f3ff",this.ctx.font="9px monospace",this.ctx.fillText(`GS:${this.gameState} G:${this.player.grounded?1:0} H:${this.hearts} B:${this.bonesCollected}`,10,68),this.ctx.fillText(`Toy:${this.hasGoldenToy?1:0} GateHint:${this.gateHintTimerSec.toFixed(2)}`,10,80),this.ctx.fillText(`State:${this.playerState} DigT:${Math.max(0,this.digTimerSec).toFixed(2)}`,10,92),this.ctx.fillText(`VX:${this.player.vx.toFixed(1)} VY:${this.player.vy.toFixed(1)}`,10,104),this.ctx.fillText(`Coyote:${t.toFixed(0)}ms`,10,116),this.ctx.fillText(`Buffer:${e.toFixed(0)}ms`,10,128)}checkGrounded(){const t={x:this.player.x,y:this.player.y+1,w:this.player.w,h:this.player.h};return m.some(e=>u(t,e,f))}resizeCanvas(){const t=window.innerWidth-24,e=window.innerHeight-150,s=Math.max(1,Math.floor(Math.min(t/v,e/w)));this.canvas.style.width=`${v*s}px`,this.canvas.style.height=`${w*s}px`}}function u(a,t,e){return a.x+e<t.x+t.w&&a.x+a.w-e>t.x&&a.y+e<t.y+t.h&&a.y+a.h-e>t.y}function Yt(a,t){const e={x:a.x+2,y:a.y+a.h,w:Math.max(1,a.w-4),h:3};return t.some(i=>i.y<160&&u(a,i,0))?!1:t.some(i=>i.y>=160&&u(e,i,0))}function Vt(){let a=m[0];for(const t of m)t.y>a.y&&(a=t);return a}function at(a){let t=2166136261;for(let e=0;e<a.length;e+=1)t^=a.charCodeAt(e),t=Math.imul(t,16777619);return jt(t>>>0)}function Ut(a){const t=at(a),e=3+Math.floor(t()*3),s=[];for(let i=0;i<e;i+=1){const n=i%2===0;s.push({xOffset:n?1+Math.floor(t()*4):A-2-Math.floor(t()*4),yOffset:1+Math.floor(t()*4),size:2+Math.floor(t()*3),shadeIndex:Math.floor(t()*3),flipX:!n})}return s}function jt(a){return()=>{let t=a+=1831565813;return t=Math.imul(t^t>>>15,t|1),t^=t+Math.imul(t^t>>>7,t|61),((t^t>>>14)>>>0)/4294967296}}function it(a,t,e){return Math.min(e,Math.max(t,a))}function E(a,t,e){return a+(t-a)*e}function st(a,t,e){return Math.abs(t-a)<=e?t:a+Math.sign(t-a)*e}function $t(){const s=document.createElement("canvas");s.width=96,s.height=72;const i=s.getContext("2d");if(!i)throw new Error("Unable to create placeholder sprite sheet");const n=(p,x,c)=>{const l=p*24,h=x*24;i.clearRect(l,h,24,24);const S="#2f4f6f",H="#6e98bf",yt="#e4f1ff",pt="#7f5b38";i.fillStyle=S,i.fillRect(l+6,h+10,12,10),i.fillRect(l+11,h+7,8,7),i.fillRect(l+14,h+5,2,2);const ft=c==="runA"||c==="runC"?12:11;if(i.fillRect(l+4,h+ft,2,4),i.fillStyle=yt,i.fillRect(l+16,h+9,1,1),i.fillStyle=H,i.fillRect(l+8,h+14,8,3),i.fillStyle=S,c==="runA")i.fillRect(l+7,h+19,2,2),i.fillRect(l+14,h+18,2,3);else if(c==="runB")i.fillRect(l+8,h+18,2,3),i.fillRect(l+13,h+19,2,2);else if(c==="runC")i.fillRect(l+7,h+18,2,3),i.fillRect(l+14,h+19,2,2);else if(c==="runD")i.fillRect(l+8,h+19,2,2),i.fillRect(l+13,h+18,2,3);else if(c==="jump")i.fillRect(l+8,h+17,2,2),i.fillRect(l+13,h+17,2,2),i.fillStyle=H,i.fillRect(l+6,h+21,12,1);else if(c==="digA"||c==="digB")i.fillRect(l+7,h+19,2,2),i.fillRect(l+13,h+19,2,2),i.fillStyle=pt,i.fillRect(l+5,h+20,14,3),c==="digB"&&(i.fillRect(l+4,h+19,2,2),i.fillRect(l+18,h+19,2,2));else{const F=c==="idleB"?1:0;i.fillRect(l+8,h+19-F,2,2+F),i.fillRect(l+13,h+19,2,2)}};n(0,0,"idleA"),n(1,0,"idleB"),n(2,0,"idleA"),n(3,0,"idleB"),n(0,1,"runA"),n(1,1,"runB"),n(2,1,"runC"),n(3,1,"runD"),n(0,2,"jump"),n(1,2,"digA"),n(2,2,"digB"),n(3,2,"idleA");const r=(p,x,c)=>({x:p*24,y:x*24,w:24,h:24,duration:c}),o={idle:[r(0,0,.16),r(1,0,.16),r(2,0,.16),r(3,0,.16)],run:[r(0,1,.1),r(1,1,.1),r(2,1,.1),r(3,1,.1)],jump:[r(0,2,.2)],digging:[r(1,2,.12),r(2,2,.12)]},y=new Image;return y.src=s.toDataURL("image/png"),{image:y,animations:o}}const nt={ArrowLeft:"left",ArrowRight:"right",ArrowDown:"dig",Space:"jumpHeld"},Xt=["left","right","jump","dig"];class zt{state={left:!1,right:!1,jumpHeld:!1,jumpPressed:!1,dig:!1,digPressed:!1};hasConsumedJump=!1;hasConsumedDig=!1;attachKeyboard(t){t.addEventListener("keydown",e=>{const s=nt[e.code];if(s){if(e.preventDefault(),s==="jumpHeld"){this.state.jumpHeld||(this.state.jumpPressed=!0),this.state.jumpHeld=!0;return}if(s==="dig"){this.state.dig||(this.state.digPressed=!0),this.state.dig=!0;return}this.state[s]=!0}}),t.addEventListener("keyup",e=>{const s=nt[e.code];if(s){if(e.preventDefault(),s==="jumpHeld"){this.state.jumpHeld=!1;return}if(s==="dig"){this.state.dig=!1;return}this.state[s]=!1}})}attachTouchButtons(t){t.forEach(e=>{const s=e.dataset.control;if(!s||!Xt.includes(s))return;const i=s,n=o=>{if(o.preventDefault(),i==="jump"){this.state.jumpHeld||(this.state.jumpPressed=!0),this.state.jumpHeld=!0;return}i==="left"&&(this.state.left=!0),i==="right"&&(this.state.right=!0),i==="dig"&&(this.state.dig||(this.state.digPressed=!0),this.state.dig=!0)},r=o=>{if(o.preventDefault(),i==="jump"){this.state.jumpHeld=!1;return}i==="left"&&(this.state.left=!1),i==="right"&&(this.state.right=!1),i==="dig"&&(this.state.dig=!1)};e.addEventListener("pointerdown",n),e.addEventListener("pointerup",r),e.addEventListener("pointerleave",r),e.addEventListener("pointercancel",r),e.addEventListener("contextmenu",o=>o.preventDefault())})}consumeJumpPressed(){return this.hasConsumedJump||!this.state.jumpPressed?!1:(this.hasConsumedJump=!0,!0)}consumeDigPressed(){return this.hasConsumedDig||!this.state.digPressed?!1:(this.hasConsumedDig=!0,!0)}endFrame(){this.state.jumpPressed=!1,this.state.digPressed=!1,this.hasConsumedJump=!1,this.hasConsumedDig=!1}}const Jt=108,R=60/Jt,b=R/2,I=8,Wt=8,Kt=I*Wt,Qt=.24,Zt=25,te=[[48,52,55],[48,52,55],[45,48,52],[45,48,52],[41,45,48],[41,45,48],[43,47,50],[43,47,50]],ee=[{step:0,note:72,lengthSteps:2},{step:2,note:76,lengthSteps:2},{step:4,note:79,lengthSteps:2},{step:6,note:76,lengthSteps:2},{step:8,note:74,lengthSteps:2},{step:10,note:76,lengthSteps:2},{step:12,note:79,lengthSteps:3},{step:15,note:81,lengthSteps:1},{step:16,note:72,lengthSteps:2},{step:18,note:69,lengthSteps:2},{step:20,note:72,lengthSteps:2},{step:22,note:76,lengthSteps:2},{step:24,note:74,lengthSteps:2},{step:26,note:72,lengthSteps:2},{step:28,note:69,lengthSteps:3},{step:31,note:67,lengthSteps:1},{step:32,note:65,lengthSteps:2},{step:34,note:69,lengthSteps:2},{step:36,note:72,lengthSteps:2},{step:38,note:69,lengthSteps:2},{step:40,note:67,lengthSteps:2},{step:42,note:69,lengthSteps:2},{step:44,note:72,lengthSteps:3},{step:47,note:74,lengthSteps:1},{step:48,note:67,lengthSteps:2},{step:50,note:71,lengthSteps:2},{step:52,note:74,lengthSteps:2},{step:54,note:71,lengthSteps:2},{step:56,note:69,lengthSteps:2},{step:58,note:67,lengthSteps:2},{step:60,note:64,lengthSteps:2},{step:62,note:71,lengthSteps:2}];class ie{audioContext=null;masterGain=null;sfxGain=null;musicGain=null;melodyDelay=null;melodyFeedback=null;melodyDelayMix=null;enabled=!0;unlockAttached=!1;musicPlaying=!1;schedulerId=null;nextStepTime=0;nextStepIndex=0;constructor(){this.attachUnlockListeners()}isEnabled(){return this.enabled}setEnabled(t){this.enabled=t,this.masterGain&&this.audioContext&&this.masterGain.gain.setValueAtTime(t?.22:0,this.audioContext.currentTime)}async unlock(){this.ensureContext(),this.audioContext&&this.audioContext.state==="suspended"&&await this.audioContext.resume()}startMusic(){this.ensureContext(),!(!this.audioContext||this.musicPlaying)&&(this.musicPlaying=!0,this.nextStepIndex=0,this.nextStepTime=this.audioContext.currentTime+.05,this.schedulerId=window.setInterval(()=>{this.scheduleMusic()},Zt))}stopMusic(){this.musicPlaying=!1,this.schedulerId!==null&&(window.clearInterval(this.schedulerId),this.schedulerId=null)}playJump(){this.createTone({frequency:500,sweepToFrequency:650,type:"square",duration:.12,volume:.11})}playStomp(){this.createTone({frequency:220,type:"square",duration:.1,volume:.12})}playDig(){this.createTone({frequency:180,sweepToFrequency:120,type:"triangle",duration:.08,volume:.09})}playBonePickup(){this.createTone({frequency:800,type:"square",duration:.1,volume:.1})}playGoldenToyPickup(){const t=this.getNow();this.createTone({frequency:700,type:"square",duration:.15,volume:.1},t),this.createTone({frequency:900,type:"square",duration:.15,volume:.1},t+.16)}playHurt(){this.createTone({frequency:300,sweepToFrequency:100,type:"sawtooth",duration:.2,volume:.12})}playGateUnlock(){this.createTone({frequency:400,sweepToFrequency:600,type:"triangle",duration:.2,volume:.1})}playLevelComplete(){const t=this.getNow();this.createTone({frequency:600,type:"square",duration:.11,volume:.11},t),this.createTone({frequency:800,type:"square",duration:.11,volume:.11},t+.13),this.createTone({frequency:1e3,type:"square",duration:.14,volume:.11},t+.26)}scheduleMusic(){if(!(!this.audioContext||!this.musicPlaying))for(;this.nextStepTime<this.audioContext.currentTime+Qt;)this.scheduleStep(this.nextStepIndex,this.nextStepTime),this.nextStepIndex=(this.nextStepIndex+1)%Kt,this.nextStepTime+=b}scheduleStep(t,e){if(!this.audioContext||!this.musicGain)return;const s=Math.floor(t/I),i=t%I,n=te[s];i===0&&this.scheduleVoice({frequency:C(n[0]-12),type:"triangle",start:e,duration:R*.95,volume:.07,attack:.008,release:.08,destination:this.musicGain}),i===4&&this.scheduleVoice({frequency:C(n[2]-12),type:"triangle",start:e,duration:R*.9,volume:.06,attack:.008,release:.08,destination:this.musicGain});const o=[0,1,2,1,0,1,2,1][i];this.scheduleVoice({frequency:C(n[o]+12),type:"square",start:e,duration:b*.78,volume:.03,attack:.005,release:.04,destination:this.musicGain});for(const y of ee){if(y.step!==t)continue;const p=y.lengthSteps*b*.92;this.scheduleMelodyVoice(C(y.note),e,p)}}scheduleMelodyVoice(t,e,s){!this.musicGain||!this.melodyDelayMix||(this.scheduleVoice({frequency:t,type:"square",start:e,duration:s,volume:.055,attack:.01,release:.1,destination:this.musicGain}),this.scheduleVoice({frequency:t,type:"square",start:e,duration:s,volume:.02,attack:.01,release:.1,destination:this.melodyDelayMix}))}getNow(){return this.ensureContext(),this.audioContext?this.audioContext.currentTime:0}createTone(t,e){if(this.ensureContext(),!this.audioContext||!this.sfxGain||!this.enabled)return;const s=e??this.audioContext.currentTime,i=this.audioContext.createOscillator(),n=this.audioContext.createGain();i.type=t.type,i.frequency.setValueAtTime(t.frequency,s),typeof t.sweepToFrequency=="number"&&i.frequency.linearRampToValueAtTime(t.sweepToFrequency,s+t.duration),n.gain.setValueAtTime(0,s),n.gain.linearRampToValueAtTime(t.volume,s+.01),n.gain.linearRampToValueAtTime(1e-4,s+t.duration),i.connect(n),n.connect(this.sfxGain),i.start(s),i.stop(s+t.duration+.02)}scheduleVoice(t){if(!this.audioContext)return;const e=this.audioContext.createOscillator(),s=this.audioContext.createGain();e.type=t.type,e.frequency.setValueAtTime(t.frequency,t.start);const i=Math.max(t.start+t.attack,t.start+t.duration-t.release);s.gain.setValueAtTime(0,t.start),s.gain.linearRampToValueAtTime(t.volume,t.start+t.attack),s.gain.setValueAtTime(t.volume,i),s.gain.linearRampToValueAtTime(1e-4,t.start+t.duration),e.connect(s),s.connect(t.destination),e.start(t.start),e.stop(t.start+t.duration+.02)}ensureContext(){if(this.audioContext)return;const t=window.AudioContext||window.webkitAudioContext;t&&(this.audioContext=new t,this.masterGain=this.audioContext.createGain(),this.sfxGain=this.audioContext.createGain(),this.musicGain=this.audioContext.createGain(),this.melodyDelay=this.audioContext.createDelay(.25),this.melodyFeedback=this.audioContext.createGain(),this.melodyDelayMix=this.audioContext.createGain(),this.masterGain.gain.value=this.enabled?.22:0,this.sfxGain.gain.value=1,this.musicGain.gain.value=.49,this.melodyDelay.delayTime.value=.15,this.melodyFeedback.gain.value=.2,this.melodyDelayMix.gain.value=1,this.sfxGain.connect(this.masterGain),this.musicGain.connect(this.masterGain),this.melodyDelayMix.connect(this.melodyDelay),this.melodyDelay.connect(this.melodyFeedback),this.melodyFeedback.connect(this.melodyDelay),this.melodyDelay.connect(this.musicGain),this.masterGain.connect(this.audioContext.destination))}attachUnlockListeners(){if(this.unlockAttached)return;this.unlockAttached=!0;const t=async()=>{await this.unlock(),this.audioContext&&this.audioContext.state==="running"&&(window.removeEventListener("pointerdown",t),window.removeEventListener("touchstart",t),window.removeEventListener("keydown",t))};window.addEventListener("pointerdown",t),window.addEventListener("touchstart",t),window.addEventListener("keydown",t)}}function C(a){return 440*Math.pow(2,(a-69)/12)}const rt=document.querySelector("#app");if(!rt)throw new Error("Missing #app container");rt.innerHTML=`
  <header class="top-bar">
    <h1>Sisu: Guardian of the Garden</h1>
    <button id="soundToggle" type="button" aria-pressed="true">Sound: On</button>
  </header>
  <main class="game-shell">
    <canvas id="gameCanvas" width="320" height="180" aria-label="Game canvas"></canvas>
    <div id="startOverlay" class="start-overlay">
      <div class="start-card">
        <h2>Sisu: Guardian of the Garden</h2>
        <p>Phase 2D Prototype</p>
        <button id="startButton" type="button">Start</button>
      </div>
    </div>
    <div id="gameOverOverlay" class="start-overlay hidden">
      <div class="start-card">
        <h2>Game Over</h2>
        <p>Press R or tap restart.</p>
        <button id="restartButton" type="button">Restart</button>
      </div>
    </div>
    <div id="levelCompleteOverlay" class="start-overlay hidden">
      <div class="start-card">
        <h2>Level Complete!</h2>
        <p id="levelStats">Bones: 0 | Hearts: 0 | Time: 0.0s</p>
        <button id="playAgainButton" type="button">Play Again</button>
        <button id="nextLevelButton" type="button" disabled>Next Level (Soon)</button>
      </div>
    </div>
  </main>
  <footer class="mobile-controls" aria-label="Touch controls">
    <button data-control="left" type="button">Left</button>
    <button data-control="right" type="button">Right</button>
    <button data-control="jump" type="button">Jump</button>
    <button data-control="dig" type="button">Dig</button>
  </footer>
`;const ot=document.querySelector("#gameCanvas"),lt=document.querySelector("#startOverlay"),ht=document.querySelector("#startButton"),G=document.querySelector("#gameOverOverlay"),ct=document.querySelector("#restartButton"),_=document.querySelector("#levelCompleteOverlay"),dt=document.querySelector("#levelStats"),ut=document.querySelector("#playAgainButton"),M=document.querySelector("#soundToggle"),se=Array.from(document.querySelectorAll("[data-control]"));if(!ot||!lt||!ht||!G||!ct||!_||!dt||!ut||!M)throw new Error("Missing required game UI elements");const L=new zt;L.attachKeyboard(window);L.attachTouchButtons(se);const g=new ie,P=new kt(ot,L,{sound:g,onGameOver:()=>{g.stopMusic(),G.classList.remove("hidden")},onLevelComplete:({bonesCollected:a,heartsRemaining:t,timeSec:e})=>{g.stopMusic(),dt.textContent=`Bones: ${a} | Hearts: ${t} | Time: ${e.toFixed(1)}s`,_.classList.remove("hidden")}}),O=()=>{P.restart(),g.startMusic(),G.classList.add("hidden"),_.classList.add("hidden")};let T=!0;M.addEventListener("click",()=>{g.unlock(),T=!T,g.setEnabled(T),M.textContent=`Sound: ${T?"On":"Off"}`,M.setAttribute("aria-pressed",String(T))});ht.addEventListener("click",()=>{g.unlock(),lt.classList.add("hidden"),P.start(),g.startMusic()});ct.addEventListener("click",O);ut.addEventListener("click",O);window.addEventListener("keydown",a=>{a.code==="KeyR"&&(P.isGameOver()||P.isLevelComplete())&&O()});
