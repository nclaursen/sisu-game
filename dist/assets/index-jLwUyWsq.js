(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const r of i)if(r.type==="childList")for(const a of r.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&s(a)}).observe(document,{childList:!0,subtree:!0});function e(i){const r={};return i.integrity&&(r.integrity=i.integrity),i.referrerPolicy&&(r.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?r.credentials="include":i.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function s(i){if(i.ep)return;i.ep=!0;const r=e(i);fetch(i.href,r)}})();const c=320,d=180,S=1200,L=900,H=650,m=170,R=.65,P=1200,C=700,x=120,g=120,o=.75,v=2,h=[{x:0,y:164,w:320,h:16},{x:52,y:128,w:72,h:10},{x:160,y:102,w:62,h:10},{x:250,y:138,w:56,h:10}];class O{canvas;ctx;input;lastTick=0;nowMs=0;isRunning=!1;lastGroundedTimeMs=-1/0;lastJumpPressedTimeMs=-1/0;previousJumpHeld=!1;debugEnabled=!1;player={x:16,y:40,w:16,h:16,vx:0,vy:0,facing:1,grounded:!1,animationTime:0};constructor(t,e){const s=t.getContext("2d");if(!s)throw new Error("2D context unavailable");this.canvas=t,this.ctx=s,this.input=e,this.ctx.imageSmoothingEnabled=!1,window.addEventListener("keydown",i=>{i.code==="Backslash"&&(this.debugEnabled=!this.debugEnabled)}),this.resizeCanvas(),window.addEventListener("resize",()=>this.resizeCanvas())}start(){this.isRunning||(this.isRunning=!0,this.lastTick=performance.now(),requestAnimationFrame(t=>this.loop(t)))}loop(t){if(!this.isRunning)return;const e=Math.min((t-this.lastTick)/1e3,1/30);this.lastTick=t,this.nowMs=t,this.update(e),this.render(),this.input.endFrame(),requestAnimationFrame(s=>this.loop(s))}update(t){const e=this.input.state,s=Number(e.right)-Number(e.left);this.input.consumeJumpPressed()&&(this.lastJumpPressedTimeMs=this.nowMs),this.player.grounded&&(this.lastGroundedTimeMs=this.nowMs),s<0?this.player.facing=-1:s>0&&(this.player.facing=1);const i=this.player.grounded?L:H;s!==0?this.player.vx+=s*i*t:this.player.grounded&&(this.player.vx=j(this.player.vx,0,P*t)),this.player.vx=I(this.player.vx,-m,m);const r=this.nowMs-this.lastJumpPressedTimeMs<=g,a=this.player.grounded||this.nowMs-this.lastGroundedTimeMs<=x;r&&a&&(this.player.vy=-420,this.player.grounded=!1,this.lastJumpPressedTimeMs=-1/0,this.lastGroundedTimeMs=-1/0),this.previousJumpHeld&&!e.jumpHeld&&this.player.vy<0&&(this.player.vy*=R),this.player.vy+=S*t,this.player.vy=Math.min(this.player.vy,C),this.moveHorizontal(t,e),this.moveVertical(t),this.player.grounded=this.checkGrounded(),this.player.grounded&&(this.lastGroundedTimeMs=this.nowMs),this.player.animationTime+=t,this.previousJumpHeld=e.jumpHeld}moveHorizontal(t,e){this.player.x+=this.player.vx*t;for(const s of h)u(this.player,s,o)&&(this.tryStepUp(e)||(this.player.vx>0&&this.player.x+this.player.w>s.x?this.player.x=s.x-this.player.w+o:this.player.vx<0&&(this.player.x=s.x+s.w-o),this.player.vx=0))}moveVertical(t){this.player.y+=this.player.vy*t;for(const e of h)u(this.player,e,o)&&(this.player.vy>0?this.player.y=e.y-this.player.h+o:this.player.vy<0&&(this.player.y=e.y+e.h-o),this.player.vy=0)}tryStepUp(t){const e=t.right&&this.player.vx>0||t.left&&this.player.vx<0;if(!this.player.grounded||!e)return!1;const s={x:this.player.x,y:this.player.y-v,w:this.player.w,h:this.player.h};return h.some(r=>u(s,r,o))?!1:(this.player.y-=v,!0)}render(){this.ctx.imageSmoothingEnabled=!1,this.ctx.clearRect(0,0,c,d),this.ctx.fillStyle="#8bd3ff",this.ctx.fillRect(0,0,c,d),this.ctx.fillStyle="#669f5d";for(const t of h)this.ctx.fillRect(t.x,t.y,t.w,t.h);this.drawPlayer(),this.drawHud(),this.debugEnabled&&this.drawDebug()}drawPlayer(){this.ctx.save(),this.player.facing===-1?(this.ctx.translate(this.player.x+this.player.w,this.player.y),this.ctx.scale(-1,1)):this.ctx.translate(this.player.x,this.player.y),this.ctx.fillStyle="#2f4f6f",this.ctx.fillRect(0,0,this.player.w,this.player.h),this.ctx.fillStyle="#ffffff",this.ctx.fillRect(11,4,2,2),this.ctx.restore()}drawHud(){this.ctx.fillStyle="rgba(12, 24, 40, 0.7)",this.ctx.fillRect(6,6,84,18),this.ctx.font="10px monospace",this.ctx.fillStyle="#f7f3c5",this.ctx.fillText("HP",11,18);for(let t=0;t<3;t+=1)this.ctx.fillStyle="#da4f5d",this.ctx.fillRect(30+t*16,10,10,10),this.ctx.strokeStyle="#81252f",this.ctx.strokeRect(30+t*16,10,10,10)}drawDebug(){const t=Math.max(0,x-(this.nowMs-this.lastGroundedTimeMs)),e=Math.max(0,g-(this.nowMs-this.lastJumpPressedTimeMs));this.ctx.fillStyle="rgba(0, 0, 0, 0.65)",this.ctx.fillRect(6,28,156,52),this.ctx.fillStyle="#d7f3ff",this.ctx.font="9px monospace",this.ctx.fillText(`G:${this.player.grounded?1:0} VX:${this.player.vx.toFixed(1)} VY:${this.player.vy.toFixed(1)}`,10,40),this.ctx.fillText(`Coyote:${t.toFixed(0)}ms`,10,52),this.ctx.fillText(`Buffer:${e.toFixed(0)}ms`,10,64)}checkGrounded(){const t={x:this.player.x,y:this.player.y+1,w:this.player.w,h:this.player.h};return h.some(e=>u(t,e,o))}resizeCanvas(){const t=window.innerWidth-24,e=window.innerHeight-150,s=Math.max(1,Math.floor(Math.min(t/c,e/d)));this.canvas.style.width=`${c*s}px`,this.canvas.style.height=`${d*s}px`}}function u(n,t,e){return n.x+e<t.x+t.w&&n.x+n.w-e>t.x&&n.y+e<t.y+t.h&&n.y+n.h-e>t.y}function I(n,t,e){return Math.min(e,Math.max(t,n))}function j(n,t,e){return Math.abs(t-n)<=e?t:n+Math.sign(t-n)*e}const w={ArrowLeft:"left",ArrowRight:"right",ArrowDown:"dig",Space:"jumpHeld"},A=["left","right","jump","dig"];class G{state={left:!1,right:!1,jumpHeld:!1,jumpPressed:!1,dig:!1};hasConsumedJump=!1;attachKeyboard(t){t.addEventListener("keydown",e=>{const s=w[e.code];if(s){if(e.preventDefault(),s==="jumpHeld"){this.state.jumpHeld||(this.state.jumpPressed=!0),this.state.jumpHeld=!0;return}this.state[s]=!0}}),t.addEventListener("keyup",e=>{const s=w[e.code];if(s){if(e.preventDefault(),s==="jumpHeld"){this.state.jumpHeld=!1;return}this.state[s]=!1}})}attachTouchButtons(t){t.forEach(e=>{const s=e.dataset.control;if(!s||!A.includes(s))return;const i=s,r=l=>{if(l.preventDefault(),i==="jump"){this.state.jumpHeld||(this.state.jumpPressed=!0),this.state.jumpHeld=!0;return}i==="left"&&(this.state.left=!0),i==="right"&&(this.state.right=!0),i==="dig"&&(this.state.dig=!0)},a=l=>{if(l.preventDefault(),i==="jump"){this.state.jumpHeld=!1;return}i==="left"&&(this.state.left=!1),i==="right"&&(this.state.right=!1),i==="dig"&&(this.state.dig=!1)};e.addEventListener("pointerdown",r),e.addEventListener("pointerup",a),e.addEventListener("pointerleave",a),e.addEventListener("pointercancel",a),e.addEventListener("contextmenu",l=>l.preventDefault())})}consumeJumpPressed(){return this.hasConsumedJump||!this.state.jumpPressed?!1:(this.hasConsumedJump=!0,!0)}endFrame(){this.state.jumpPressed=!1,this.hasConsumedJump=!1}}const T=document.querySelector("#app");if(!T)throw new Error("Missing #app container");T.innerHTML=`
  <header class="top-bar">
    <h1>Sisu: Guardian of the Garden</h1>
    <button id="soundToggle" type="button" aria-pressed="false">Sound: Off</button>
  </header>
  <main class="game-shell">
    <canvas id="gameCanvas" width="320" height="180" aria-label="Game canvas"></canvas>
    <div id="startOverlay" class="start-overlay">
      <div class="start-card">
        <h2>Sisu: Guardian of the Garden</h2>
        <p>Phase 1 Prototype</p>
        <button id="startButton" type="button">Start</button>
      </div>
    </div>
  </main>
  <footer class="mobile-controls" aria-label="Touch controls">
    <button data-control="left" type="button">Left</button>
    <button data-control="right" type="button">Right</button>
    <button data-control="jump" type="button">Jump</button>
    <button data-control="dig" type="button">Dig</button>
  </footer>
`;const M=document.querySelector("#gameCanvas"),b=document.querySelector("#startOverlay"),E=document.querySelector("#startButton"),p=document.querySelector("#soundToggle"),_=Array.from(document.querySelectorAll("[data-control]"));if(!M||!b||!E||!p)throw new Error("Missing required game UI elements");const y=new G;y.attachKeyboard(window);y.attachTouchButtons(_);const J=new O(M,y);let f=!1;p.addEventListener("click",()=>{f=!f,p.textContent=`Sound: ${f?"On":"Off"}`,p.setAttribute("aria-pressed",String(f))});E.addEventListener("click",()=>{b.classList.add("hidden"),J.start()});
