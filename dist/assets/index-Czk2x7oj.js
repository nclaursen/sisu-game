(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))i(s);new MutationObserver(s=>{for(const a of s)if(a.type==="childList")for(const n of a.addedNodes)n.tagName==="LINK"&&n.rel==="modulepreload"&&i(n)}).observe(document,{childList:!0,subtree:!0});function e(s){const a={};return s.integrity&&(a.integrity=s.integrity),s.referrerPolicy&&(a.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?a.credentials="include":s.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function i(s){if(s.ep)return;s.ep=!0;const a=e(s);fetch(s.href,a)}})();const U=56,nt=.18,Ht={rat:{width:14,height:12,speed:U,hp:1,baseColor:"#8b2e3b",eyeColor:"#f8d7db"},mouse:{width:11,height:9,speed:U*1.4,hp:1,baseColor:"#8c5a73",eyeColor:"#f9e9f2"},tank:{width:17,height:14,speed:U*.75,hp:2,baseColor:"#4d5f72",eyeColor:"#d8e7f5"}};class Yt{type;maxHp;width;height;speed;baseColor;eyeColor;x;y;vx;vy;facing;grounded=!1;alive=!0;hp;hitStunTimerSec=0;spawnTimerSec=nt;animTimerSec=0;constructor(t){const e=Ht[t.type];this.type=t.type,this.maxHp=e.hp,this.width=e.width,this.height=e.height,this.speed=e.speed,this.baseColor=e.baseColor,this.eyeColor=e.eyeColor,this.x=t.x,this.y=t.y,this.facing=t.facing??-1,this.vx=this.speed*this.facing,this.vy=0,this.hp=this.maxHp}update(t,e,i,s,a){if(!this.alive)return;this.hitStunTimerSec>0&&(this.hitStunTimerSec=Math.max(0,this.hitStunTimerSec-t)),this.spawnTimerSec>0&&(this.spawnTimerSec=Math.max(0,this.spawnTimerSec-t)),this.animTimerSec+=t;const n=this.hitStunTimerSec<=0;if(n&&this.grounded&&!this.hasGroundAhead(e)&&this.reverseDirection(),this.vx=n?this.speed*this.facing:0,this.x+=this.vx*t,n){let o=!1;for(const l of e)ot(this.getBody(),l,a)&&(o=!0,this.vx>0?this.x=l.x-this.width+a:this.vx<0&&(this.x=l.x+l.w-a));o&&(this.reverseDirection(),this.vx=this.speed*this.facing)}this.vy=Math.min(this.vy+i*t,s),this.y+=this.vy*t,this.grounded=!1;for(const o of e)ot(this.getBody(),o,a)&&(this.vy>0?(this.y=o.y-this.height+a,this.grounded=!0):this.vy<0&&(this.y=o.y+o.h-a),this.vy=0)}draw(t){if(!this.alive)return;const e=this.getBody(),i=this.spawnTimerSec>0?.8+(1-this.spawnTimerSec/nt)*.2:1,s=e.x+e.w/2,a=e.y+e.h,n=e.w*i,o=e.h*i,l=s-n/2,h=a-o,c=Ft(this.type),d=Math.floor(this.animTimerSec/c.frameDuration)%2,u=this.type==="tank"&&this.hp===1?1:0;if(c.image.complete&&c.image.naturalWidth>0){const m=d*c.frameW,p=u*c.frameH;t.save(),this.facing===-1?(t.translate(l+n,h),t.scale(-1,1),t.drawImage(c.image,m,p,c.frameW,c.frameH,0,0,n,o)):t.drawImage(c.image,m,p,c.frameW,c.frameH,l,h,n,o),t.restore();return}t.save(),t.fillStyle=this.baseColor,t.fillRect(l,h,n,o),t.fillStyle=this.eyeColor,t.fillRect(l+n-3,h+3,2,2),t.restore()}canDamagePlayer(){return this.alive&&this.hitStunTimerSec<=0&&this.spawnTimerSec<=0}applyStomp(){return this.alive?(this.hp-=1,this.hitStunTimerSec=.2,this.hp<=0?(this.alive=!1,this.vx=0,this.vy=0,"killed"):"damaged"):"killed"}isAlive(){return this.alive}getBody(){return{x:this.x,y:this.y,w:this.width,h:this.height}}hasGroundAhead(t){const e=this.facing===1?this.x+this.width+2:this.x-2,i=this.y+this.height+2;return t.some(s=>{const a=e>=s.x&&e<=s.x+s.w,n=i>=s.y&&i<=s.y+s.h+1;return a&&n})}reverseDirection(){this.facing=this.facing===1?-1:1}}function at(r,t,e,i=-1){return new Yt({type:r,x:t,y:e,facing:i})}function ot(r,t,e){return r.x+e<t.x+t.w&&r.x+r.w-e>t.x&&r.y+e<t.y+t.h&&r.y+r.h-e>t.y}function Ft(r){return j||(j=qt()),j[r]}let j=null;function qt(){return{rat:Wt(),mouse:Xt(),tank:Vt()}}function Wt(){const e=document.createElement("canvas");e.width=40,e.height=14;const i=e.getContext("2d");if(!i)throw new Error("Unable to create rat sprite");const s=n=>{const o=n*20,l="#2f2420",h="#5c4639",c="#7c604b",d="#d8595b",u="#a78176";i.fillStyle=u,i.fillRect(o+1,8,5,1),i.fillRect(o+0,9,3,1),i.fillStyle=l,i.fillRect(o+5,5,11,6),i.fillRect(o+14,4,4,4),i.fillStyle=h,i.fillRect(o+6,6,9,4),i.fillRect(o+14,5,3,2),i.fillStyle=c,i.fillRect(o+8,7,5,2),i.fillStyle=l,i.fillRect(o+15,3,1,1),i.fillStyle=d,i.fillRect(o+16,6,1,1),i.fillStyle=l,n===0?(i.fillRect(o+7,11,2,2),i.fillRect(o+12,10,2,3)):(i.fillRect(o+8,10,2,3),i.fillRect(o+12,11,2,2))};s(0),s(1);const a=new Image;return a.src=e.toDataURL("image/png"),{image:a,frameW:20,frameH:14,frameDuration:.12}}function Xt(){const e=document.createElement("canvas");e.width=32,e.height=12;const i=e.getContext("2d");if(!i)throw new Error("Unable to create mouse sprite");const s=n=>{const o=n*16,l="#493744",h="#8c6f82",c="#d2a8bf",d="#ff8088",u="#cfafba";i.fillStyle=u,i.fillRect(o+0,7,4,1),i.fillStyle=l,i.fillRect(o+4,5,8,4),i.fillRect(o+10,4,3,3),i.fillStyle=h,i.fillRect(o+5,6,6,2),i.fillStyle=c,i.fillRect(o+9,2,2,2),i.fillRect(o+11,2,2,2),i.fillStyle=d,i.fillRect(o+11,5,1,1),i.fillStyle=l,n===0?(i.fillRect(o+5,9,1,2),i.fillRect(o+9,8,1,3)):(i.fillRect(o+6,8,1,3),i.fillRect(o+9,9,1,2))};s(0),s(1);const a=new Image;return a.src=e.toDataURL("image/png"),{image:a,frameW:16,frameH:12,frameDuration:.08}}function Vt(){const e=document.createElement("canvas");e.width=44,e.height=32;const i=e.getContext("2d");if(!i)throw new Error("Unable to create tank sprite");const s=(n,o)=>{const l=n*22,h=o?16:0,c="#2d3a48",d="#526475",u="#9caec2",m="#deeffa",p="#6f8397";i.fillStyle=p,i.fillRect(l+1,h+9,5,1),i.fillStyle=c,i.fillRect(l+5,h+6,13,7),i.fillRect(l+15,h+5,4,4),i.fillStyle=d,i.fillRect(l+6,h+7,11,5),i.fillStyle=u,i.fillRect(l+6,h+8,11,2),o&&(i.fillStyle="#263443",i.fillRect(l+11,h+8,1,2),i.fillRect(l+12,h+9,1,1),i.fillRect(l+10,h+9,1,1)),i.fillStyle=m,i.fillRect(l+17,h+7,1,1),i.fillStyle=c,n===0?(i.fillRect(l+7,h+13,2,2),i.fillRect(l+13,h+12,2,3)):(i.fillRect(l+8,h+12,2,3),i.fillRect(l+13,h+13,2,2))};s(0,!1),s(1,!1),s(0,!0),s(1,!0);const a=new Image;return a.src=e.toDataURL("image/png"),{image:a,frameW:22,frameH:16,frameDuration:.14}}const b=320,M=180,$t=b*.4,rt=1200,Ut=900,jt=650,lt=170,zt=.65,ht=1200,ct=700,dt=120,ut=120,E=.75,ft=2,z=3,Jt=1,yt=190,Kt=4,Zt=.5,mt=3,Qt=6,B=16,pt=6,te=.1,ee=28,ie=34,se=28,ne=.7,xt=.3,ae=-120,oe=520,re=2.5,gt=.45,le=.2,he=.35,ce=.075,de=600,St=30,ue=8,fe=12,ye="170, 142, 104",me=16,pe=112,xe=1.5,J=16,wt=40,ge={id:"wild-garden",name:"Wild Garden",width:1800,height:M,backgroundColor:"#8bd3ff",platforms:[{x:0,y:164,w:1800,h:16},{x:96,y:136,w:74,h:10},{x:232,y:122,w:62,h:10},{x:410,y:138,w:84,h:10},{x:548,y:120,w:70,h:10},{x:668,y:140,w:72,h:10},{x:804,y:128,w:86,h:10},{x:932,y:108,w:72,h:10},{x:1048,y:128,w:86,h:10},{x:1220,y:130,w:80,h:10},{x:1342,y:108,w:78,h:10},{x:1462,y:90,w:72,h:10},{x:1584,y:132,w:88,h:10},{x:1708,y:142,w:64,h:10}],enemySpawnPoints:[{x:160,groundY:164},{x:448,groundY:164},{x:632,groundY:164},{x:838,groundY:128},{x:1078,groundY:128},{x:1312,groundY:130},{x:1496,groundY:90},{x:1628,groundY:164},{x:1738,groundY:164}],goldenToyPosition:{x:1452,y:76},exitGatePosition:{x:1682,y:132},digSeed:"wild-garden-seed",backgroundLayers:[{kind:"gradient",parallax:0},{kind:"treeLine",parallax:.2,seed:11,y:146},{kind:"hills",parallax:.35,seed:23,y:157},{kind:"fenceLine",parallax:.5,seed:37,y:160}],decorations:[{kind:"grass",x:110,y:164,variant:0,depth:"mid"},{kind:"flower",x:132,y:164,variant:0,depth:"mid"},{kind:"weed",x:188,y:164,variant:1,depth:"mid"},{kind:"rock",x:256,y:164,variant:0,depth:"mid"},{kind:"grass",x:420,y:164,variant:1,depth:"mid"},{kind:"flower",x:466,y:164,variant:1,depth:"mid"},{kind:"bush",x:532,y:164,variant:0,depth:"far"},{kind:"mushroom",x:604,y:164,variant:0,depth:"mid"},{kind:"weed",x:696,y:164,variant:0,depth:"mid"},{kind:"grass",x:816,y:164,variant:1,depth:"mid"},{kind:"flower",x:878,y:164,variant:2,depth:"mid"},{kind:"rock",x:948,y:164,variant:1,depth:"mid"},{kind:"bush",x:1020,y:164,variant:1,depth:"far"},{kind:"weed",x:1118,y:164,variant:0,depth:"mid"},{kind:"grass",x:1248,y:164,variant:2,depth:"mid"},{kind:"flower",x:1302,y:164,variant:0,depth:"mid"},{kind:"vine",x:1368,y:108,variant:0,depth:"near"},{kind:"vine",x:1488,y:90,variant:1,depth:"near"},{kind:"bush",x:1528,y:164,variant:0,depth:"far"},{kind:"fencePost",x:1608,y:164,variant:0,depth:"near"},{kind:"fencePost",x:1638,y:164,variant:1,depth:"near"},{kind:"flower",x:1670,y:164,variant:1,depth:"mid"},{kind:"grass",x:1724,y:164,variant:1,depth:"mid"},{kind:"rock",x:1760,y:164,variant:0,depth:"mid"}]},Se={id:"courtyard",name:"Courtyard",width:2200,height:M,backgroundColor:"#d9dde2",platforms:[{x:0,y:164,w:2200,h:16},{x:40,y:144,w:70,h:10},{x:150,y:122,w:62,h:10},{x:250,y:100,w:54,h:10},{x:350,y:132,w:72,h:10},{x:500,y:112,w:58,h:10},{x:620,y:90,w:54,h:10},{x:760,y:124,w:70,h:10},{x:920,y:102,w:56,h:10},{x:1040,y:82,w:54,h:10},{x:1180,y:126,w:72,h:10},{x:1360,y:106,w:60,h:10},{x:1500,y:86,w:54,h:10},{x:1650,y:122,w:74,h:10},{x:1830,y:100,w:60,h:10},{x:1980,y:124,w:76,h:10}],enemySpawnPoints:[{x:70,groundY:144},{x:390,groundY:132},{x:800,groundY:124},{x:1210,groundY:126},{x:1690,groundY:122},{x:2020,groundY:124}],goldenToyPosition:{x:1700,y:74},exitGatePosition:{x:2080,y:132},digSeed:"courtyard-seed"},we={id:"snow-garden",name:"Snow Garden",width:2200,height:M,backgroundColor:"#b7d4ef",platforms:[{x:0,y:164,w:2200,h:16},{x:70,y:132,w:86,h:10},{x:220,y:110,w:72,h:10},{x:390,y:136,w:92,h:10},{x:540,y:102,w:74,h:10},{x:700,y:126,w:84,h:10},{x:890,y:98,w:80,h:10},{x:1080,y:136,w:96,h:10},{x:1260,y:108,w:78,h:10},{x:1450,y:124,w:90,h:10},{x:1640,y:96,w:82,h:10},{x:1830,y:130,w:94,h:10},{x:2010,y:112,w:72,h:10}],enemySpawnPoints:[{x:120,groundY:132},{x:430,groundY:136},{x:740,groundY:126},{x:1120,groundY:136},{x:1500,groundY:124},{x:1860,groundY:130}],goldenToyPosition:{x:1640,y:84},exitGatePosition:{x:2080,y:132},digSeed:"snow-garden-seed"},_=[ge,Se,we],ve=[{type:"rat",weight:.5},{type:"mouse",weight:.3},{type:"tank",weight:.2}],Te=3,vt=6,Tt=10,Re=2,Ee=3,Me=120,Ce=22,G={w:8,h:8},k={w:18,h:32};class be{canvas;ctx;input;onGameOver;onLevelComplete;onDemoComplete;sound;enemies=[];playerSpriteImage;playerAnimations;playerSpriteReady=!1;currentPlayerAnimation="idle";playerAnimationFrameIndex=0;playerAnimationFrameElapsed=0;lastTick=0;nowMs=0;isRunning=!1;lastGroundedTimeMs=-1/0;lastJumpPressedTimeMs=-1/0;previousJumpHeld=!1;debugEnabled=!1;hearts=z;bonesCollected=0;invincibleTimerSec=0;gameState="playing";elapsedSec=0;levelIndex=0;levelTitleTimerSec=0;camera={x:0,y:0};activeDecorations=[];preparedBackgroundLayers=[];ambientPollen=[];skyGradient=null;playerState="normal";digTimerSec=0;activeDigSpotIndex=null;digSpots=[];bones=[];digParticles=[];digEmitTimerSec=0;goldenToy={x:0,y:0,w:G.w,h:G.h,collected:!1};exitGate={x:0,y:0,w:k.w,h:k.h};hasGoldenToy=!1;gateHintTimerSec=0;spawnTimerSec=0;pendingRespawnTimers=[];player={x:J,y:wt,w:16,h:16,vx:0,vy:0,facing:1,grounded:!1,animationTime:0};constructor(t,e,i={}){const s=t.getContext("2d");if(!s)throw new Error("2D context unavailable");this.canvas=t,this.ctx=s,this.input=e,this.onGameOver=i.onGameOver,this.onLevelComplete=i.onLevelComplete,this.onDemoComplete=i.onDemoComplete,this.sound=i.sound,this.loadLevel(0);const a=Ge();this.playerSpriteImage=a.image,this.playerAnimations=a.animations,this.playerSpriteImage.onload=()=>{this.playerSpriteReady=!0},this.ctx.imageSmoothingEnabled=!1,window.addEventListener("keydown",n=>{n.code==="Backslash"&&(this.debugEnabled=!this.debugEnabled)}),this.resizeCanvas(),window.addEventListener("resize",()=>this.resizeCanvas())}start(){this.isRunning||(this.isRunning=!0,this.lastTick=performance.now(),requestAnimationFrame(t=>this.loop(t)))}restart(){this.loadLevel(this.levelIndex)}restartFromFirstLevel(){this.loadLevel(0)}nextLevel(){return this.levelIndex+1>=_.length?(this.gameState="demoComplete",this.onDemoComplete?.({bonesCollected:this.bonesCollected,heartsRemaining:this.hearts,timeSec:this.elapsedSec,levelName:this.currentLevel().name}),!1):(this.loadLevel(this.levelIndex+1),!0)}isDemoComplete(){return this.gameState==="demoComplete"}getCurrentLevelName(){return this.currentLevel().name}hasNextLevel(){return this.levelIndex+1<_.length}loadLevel(t){this.levelIndex=L(t,0,_.length-1),this.hearts=z,this.bonesCollected=0,this.invincibleTimerSec=0,this.gameState="playing",this.lastGroundedTimeMs=-1/0,this.lastJumpPressedTimeMs=-1/0,this.previousJumpHeld=!1,this.elapsedSec=0,this.playerState="normal",this.digTimerSec=0,this.activeDigSpotIndex=null,this.digEmitTimerSec=0,this.player.x=J,this.player.y=wt,this.player.vx=0,this.player.vy=0,this.player.facing=1,this.player.grounded=!1,this.player.animationTime=0,this.currentPlayerAnimation="idle",this.playerAnimationFrameIndex=0,this.playerAnimationFrameElapsed=0,this.resetEnemyWave(),this.digSpots=this.generateDigSpots(this.currentLevel().digSeed),this.preparedBackgroundLayers=this.prepareBackgroundLayers(this.currentLevel()),this.bones=[],this.digParticles=[],this.goldenToy={x:this.currentLevel().goldenToyPosition.x,y:this.currentLevel().goldenToyPosition.y,w:G.w,h:G.h,collected:!1},this.exitGate={x:this.currentLevel().exitGatePosition.x,y:this.currentLevel().exitGatePosition.y,w:k.w,h:k.h},this.hasGoldenToy=!1,this.gateHintTimerSec=0,this.levelTitleTimerSec=1.5,this.activeDecorations=this.prepareDecorations(this.currentLevel()),this.ambientPollen=this.createAmbientPollen(this.currentLevel()),this.skyGradient=this.ctx.createLinearGradient(0,0,0,M),this.skyGradient.addColorStop(0,"#9ad8ff"),this.skyGradient.addColorStop(1,this.currentLevel().backgroundColor),this.camera.x=0,this.camera.y=0}isGameOver(){return this.gameState==="gameOver"}isLevelComplete(){return this.gameState==="levelComplete"}loop(t){if(!this.isRunning)return;const e=Math.min((t-this.lastTick)/1e3,1/30);this.lastTick=t,this.nowMs=t,this.update(e),this.render(),this.input.endFrame(),requestAnimationFrame(i=>this.loop(i))}update(t){if(this.gameState!=="playing")return;const e=this.input.state,i=Number(e.right)-Number(e.left),s=this.player.y+this.player.h;if(this.elapsedSec+=t,this.invincibleTimerSec>0&&(this.invincibleTimerSec=Math.max(0,this.invincibleTimerSec-t)),this.gateHintTimerSec>0&&(this.gateHintTimerSec=Math.max(0,this.gateHintTimerSec-t)),this.levelTitleTimerSec>0&&(this.levelTitleTimerSec=Math.max(0,this.levelTitleTimerSec-t)),this.playerState==="normal"&&this.input.consumeDigPressed()){const a=this.findDigSpotForPlayer();this.player.grounded&&a!==null&&(this.playerState="digging",this.digTimerSec=Zt,this.activeDigSpotIndex=a,this.player.vx=0)}if(this.player.grounded&&(this.lastGroundedTimeMs=this.nowMs),this.playerState==="normal"){this.input.consumeJumpPressed()&&(this.lastJumpPressedTimeMs=this.nowMs),i<0?this.player.facing=-1:i>0&&(this.player.facing=1);const a=this.player.grounded?Ut:jt;i!==0?this.player.vx+=i*a*t:this.player.grounded&&(this.player.vx=Rt(this.player.vx,0,ht*t)),this.player.vx=L(this.player.vx,-lt,lt);const n=this.nowMs-this.lastJumpPressedTimeMs<=ut,o=this.player.grounded||this.nowMs-this.lastGroundedTimeMs<=dt;n&&o&&(this.player.vy=-420,this.player.grounded=!1,this.lastJumpPressedTimeMs=-1/0,this.lastGroundedTimeMs=-1/0,this.sound?.playJump()),this.previousJumpHeld&&!e.jumpHeld&&this.player.vy<0&&(this.player.vy*=zt)}else this.player.grounded&&(this.player.vx=Rt(this.player.vx,0,ht*t)),this.emitDigParticlesWhileDigging(t),this.digTimerSec-=t,this.digTimerSec<=0&&this.finishDig();this.player.vy+=rt*t,this.player.vy=Math.min(this.player.vy,ct),this.moveHorizontal(t,e),this.clampPlayerToWorldBounds(),this.moveVertical(t),this.player.grounded=this.checkGrounded(),this.player.grounded&&(this.lastGroundedTimeMs=this.nowMs),this.updateEnemySpawning(t);for(const a of this.enemies)a.update(t,this.currentLevel().platforms,rt,ct,E);this.handlePlayerEnemyCollision(s),this.updateBonesAndParticles(t),this.handleGoldenToyAndGate(),this.updateAmbientPollen(t),this.updateCamera(),this.updatePlayerAnimation(t),this.player.animationTime+=t,this.previousJumpHeld=e.jumpHeld}moveHorizontal(t,e){this.player.x+=this.player.vx*t;for(const i of this.currentLevel().platforms)x(this.player,i,E)&&(this.tryStepUp(e)||(this.player.vx>0&&this.player.x+this.player.w>i.x?this.player.x=i.x-this.player.w+E:this.player.vx<0&&(this.player.x=i.x+i.w-E),this.player.vx=0))}moveVertical(t){this.player.y+=this.player.vy*t;for(const e of this.currentLevel().platforms)x(this.player,e,E)&&(this.player.vy>0?this.player.y=e.y-this.player.h+E:this.player.vy<0&&(this.player.y=e.y+e.h-E),this.player.vy=0)}clampPlayerToWorldBounds(){const t=this.currentLevel().width-this.player.w;this.player.x<0?(this.player.x=0,this.player.vx=Math.max(0,this.player.vx)):this.player.x>t&&(this.player.x=t,this.player.vx=Math.min(0,this.player.vx))}tryStepUp(t){const e=t.right&&this.player.vx>0||t.left&&this.player.vx<0;if(!this.player.grounded||!e)return!1;const i={x:this.player.x,y:this.player.y-ft,w:this.player.w,h:this.player.h};return this.currentLevel().platforms.some(a=>x(i,a,E))?!1:(this.player.y-=ft,!0)}handlePlayerEnemyCollision(t){for(let e=this.enemies.length-1;e>=0;e-=1){const i=this.enemies[e];if(!i.isAlive())continue;const s=i.getBody();if(!x(this.player,s,0))continue;const a=this.player.y+this.player.h;if(this.player.vy>0&&t<=s.y+Kt&&a>=s.y){const h=i.applyStomp();this.player.vy=-189,this.player.grounded=!1,this.lastGroundedTimeMs=-1/0,this.sound?.playStomp(),h==="killed"&&(this.enemies.splice(e,1),this.pendingRespawnTimers.push(this.randomRange(Re,Ee)));return}if(this.invincibleTimerSec>0||!i.canDamagePlayer())continue;this.hearts=Math.max(0,this.hearts-1),this.invincibleTimerSec=Jt;const o=this.player.x+this.player.w/2,l=s.x+s.w/2;this.player.vx=o<l?-yt:yt,this.player.vy=-220,this.player.grounded=!1,this.sound?.playHurt(),this.hearts<=0&&(this.gameState="gameOver",this.onGameOver?.());return}}resetEnemyWave(){this.enemies=[],this.pendingRespawnTimers=[],this.spawnTimerSec=this.randomRange(vt,Tt),this.spawnEnemyIfPossible()}updateEnemySpawning(t){this.spawnTimerSec-=t,this.spawnTimerSec<=0&&(this.spawnEnemyIfPossible(),this.spawnTimerSec=this.randomRange(vt,Tt));for(let e=this.pendingRespawnTimers.length-1;e>=0;e-=1)this.pendingRespawnTimers[e]-=t,this.pendingRespawnTimers[e]<=0&&(this.spawnEnemyIfPossible()?this.pendingRespawnTimers.splice(e,1):this.pendingRespawnTimers[e]=1)}spawnEnemyIfPossible(){if(this.enemies.length>=Te)return!1;const t=this.pickEnemyType(),i=at(t,0,0).getBody(),s=this.player.x+this.player.w/2,a=[...this.currentLevel().enemySpawnPoints].sort(()=>Math.random()-.5);for(const n of a){const o=n.x,l=n.groundY-i.h-.01,h={x:o,y:l,w:i.w,h:i.h},c=o+h.w/2;if(Math.abs(c-s)<Me||this.enemies.some(g=>{const C=g.getBody(),R=C.x+C.w/2;return Math.abs(R-c)<Ce})||this.currentLevel().platforms.some(g=>x(h,g,0))||!this.currentLevel().platforms.some(g=>{const C=h.x+h.w/2,R=h.y+h.h+2,I=C>=g.x&&C<=g.x+g.w,W=R>=g.y&&R<=g.y+g.h+2;return I&&W}))continue;const p=c>s?-1:1,T=at(t,h.x,h.y,p);return this.enemies.push(T),this.emitEnemySpawnPoof(T.getBody()),!0}return!1}pickEnemyType(){const t=Math.random();let e=0;for(const i of ve)if(e+=i.weight,t<=e)return i.type;return"rat"}randomRange(t,e){return t+Math.random()*(e-t)}emitEnemySpawnPoof(t){const e=Math.floor(this.randomRange(ue,fe+1)),i=t.x+t.w/2,s=t.y+t.h-2;for(let a=0;a<e;a+=1){const n=Math.random()*Math.PI*2,o=this.randomRange(22,70),l=Math.random()<.5?2:3,h=this.randomRange(.25,.35);this.pushDigParticle({x:i+Math.cos(n)*2,y:s+Math.sin(n)*1.5,w:l,h:l,vx:L(Math.cos(n)*o,-60,60),vy:L(Math.sin(n)*o-80,-120,-40),lifeSec:h,maxLifeSec:h,colorRgb:ye})}}handleGoldenToyAndGate(){if(!this.goldenToy.collected&&x(this.player,this.goldenToy,0)&&(this.goldenToy.collected=!0,this.hasGoldenToy=!0,this.sound?.playGoldenToyPickup(),this.sound?.playGateUnlock()),!!x(this.player,this.exitGate,0)){if(!this.hasGoldenToy){this.gateHintTimerSec=Math.max(this.gateHintTimerSec,xe);return}this.gameState="levelComplete",this.sound?.playLevelComplete(),this.onLevelComplete?.({bonesCollected:this.bonesCollected,heartsRemaining:this.hearts,timeSec:this.elapsedSec,levelName:this.currentLevel().name,hasNextLevel:this.hasNextLevel()})}}updateBonesAndParticles(t){for(const e of this.bones)e.active&&(e.state==="popping"&&(e.popTimerSec+=t,e.vy+=oe*t,e.y+=e.vy*t,e.popTimerSec<xt*.75?e.y=Math.max(e.targetY,e.y):e.y=Math.min(e.settleY,Math.max(e.targetY,e.y)),e.popTimerSec>=xt&&(e.state="idle",e.y=e.settleY,e.vy=0)),e.state==="idle"&&x(this.player,e,0)&&(e.active=!1,this.bonesCollected+=1,this.sound?.playBonePickup()));for(let e=this.digParticles.length-1;e>=0;e-=1){const i=this.digParticles[e];if(i.lifeSec-=t,i.lifeSec<=0){this.digParticles.splice(e,1);continue}i.x+=i.vx*t,i.y+=i.vy*t,i.vy+=de*t}}finishDig(){if(this.playerState="normal",this.sound?.playDig(),this.activeDigSpotIndex===null)return;const t=this.digSpots[this.activeDigSpotIndex];this.activeDigSpotIndex=null,!(!t||t.dug)&&(t.dug=!0,t.hasBone?this.spawnBoneFromSpot(t):this.spawnEmptyDigPuff(t))}spawnBoneFromSpot(t){const s=t.y+t.h,a=s-4,n=s-12,o=n+re;this.bones.push({x:t.x+(t.w-8)/2,y:a,w:8,h:6,active:!0,vy:ae,state:"popping",popTimerSec:0,startY:a,targetY:n,settleY:o})}spawnEmptyDigPuff(t){const e=t.x+t.w/2,i=t.y+1,s=3+Math.floor((t.x+t.y)%4);for(let a=0;a<s;a+=1){const n=a-(s-1)/2;this.pushDigParticle({x:e+n*2,y:i,w:3,h:3,vx:n*16,vy:-45-Math.abs(n)*5,lifeSec:gt,maxLifeSec:gt,colorRgb:"120, 78, 42"})}}emitDigParticlesWhileDigging(t){if(this.activeDigSpotIndex===null)return;const e=this.digSpots[this.activeDigSpotIndex];if(e)for(this.digEmitTimerSec-=t;this.digEmitTimerSec<=0;){this.digEmitTimerSec+=ce;const i=1+Math.floor(Math.random()*2);for(let s=0;s<i;s+=1){const a=Math.random()<.5?2:3,n=O(le,he,Math.random());this.pushDigParticle({x:e.x+e.w*(.25+Math.random()*.5),y:e.y+e.h-1,w:a,h:a,vx:O(-40,40,Math.random()),vy:O(-120,-60,Math.random()),lifeSec:n,maxLifeSec:n,colorRgb:"120, 78, 42"})}}}pushDigParticle(t){this.digParticles.push(t),this.digParticles.length>St&&this.digParticles.splice(0,this.digParticles.length-St)}findDigSpotForPlayer(){for(let t=0;t<this.digSpots.length;t+=1){const e=this.digSpots[t];if(!e.dug&&x(this.player,e,0))return t}return null}generateDigSpots(t){const e=Pe(this.currentLevel().platforms),i=H(t),s=mt+Math.floor(i()*(Qt-mt+1)),a=Math.max(e.x+Math.floor(this.currentLevel().width*te),e.x+ee),n=e.x+e.w-B-2,o=[];let l=0;for(;o.length<s&&l<300;){l+=1;const h=Math.floor(O(a,n,i())),c=h+B/2;if(this.currentLevel().enemySpawnPoints.some(T=>Math.abs(c-T.x)<ie)||o.some(T=>Math.abs(c-(T.x+T.w/2))<se))continue;const m=e.y-pt,p={x:h,y:m,w:B,h:pt,dug:!1,hasBone:i()<ne,dirtDecor:Ae(`${t}:${h}:${m}`)};Le(p,this.currentLevel().platforms)&&o.push(p)}return o}render(){this.ctx.imageSmoothingEnabled=!1,this.ctx.clearRect(0,0,b,M),this.drawBackgroundLayers(),this.ctx.save(),this.ctx.translate(-this.camera.x,-this.camera.y),this.drawPlatforms(),this.drawDecorations("far"),this.drawDecorations("mid"),this.drawExitGate(),this.drawGoldenToy(),this.drawDigSpots(),this.drawBones();for(const t of this.enemies)t.draw(this.ctx);this.drawPlayer(),this.drawDecorations("near"),this.drawDigParticles(),this.drawAmbientPollen(),this.ctx.restore(),this.drawHud(),this.gateHintTimerSec>0&&this.drawGateHint(),this.levelTitleTimerSec>0&&this.drawLevelTitle(),this.debugEnabled&&this.drawDebug()}drawExitGate(){const t=this.hasGoldenToy,e=.75+Math.sin(this.nowMs*.01)*.25;this.ctx.fillStyle=t?`rgba(76, 178, 89, ${e.toFixed(3)})`:"#6d5f67",this.ctx.fillRect(this.exitGate.x,this.exitGate.y,this.exitGate.w,this.exitGate.h),this.ctx.fillStyle=t?"#c8f3ce":"#a99ca4";const i=3;for(let s=0;s<i;s+=1){const a=this.exitGate.x+3+s*4;this.ctx.fillRect(a,this.exitGate.y+3,2,this.exitGate.h-6)}this.ctx.strokeStyle="#283040",this.ctx.strokeRect(this.exitGate.x,this.exitGate.y,this.exitGate.w,this.exitGate.h)}drawGoldenToy(){if(this.goldenToy.collected)return;const t=1+Math.sin(this.nowMs*.012)*.1,e=this.goldenToy.w*t,i=this.goldenToy.h*t,s=this.goldenToy.x-(e-this.goldenToy.w)/2,a=this.goldenToy.y-(i-this.goldenToy.h)/2;this.ctx.fillStyle="#f5cb42",this.ctx.fillRect(s,a,e,i),this.ctx.fillStyle="#fff2b8",this.ctx.fillRect(s+2,a+2,Math.max(1,e-4),Math.max(1,i-4)),this.ctx.strokeStyle="#a87f18",this.ctx.strokeRect(s,a,e,i)}drawDigSpots(){for(let t=0;t<this.digSpots.length;t+=1){const e=this.digSpots[t],i=this.activeDigSpotIndex===t&&this.playerState==="digging";this.ctx.fillStyle=e.dug?"#8c6a49":"#7a5433",this.ctx.fillRect(e.x,e.y,e.w,e.h),e.dug?(this.ctx.fillStyle="#4c3826",this.ctx.fillRect(e.x+2,e.y+2,e.w-4,2),this.drawDugSpotDecor(e)):(this.ctx.fillStyle=i?"#f1c27d":"#b07a4a",this.ctx.fillRect(e.x+2,e.y+1,2,2),this.ctx.fillRect(e.x+e.w-4,e.y+1,2,2)),this.debugEnabled&&(this.ctx.strokeStyle="rgba(255, 255, 0, 0.8)",this.ctx.strokeRect(e.x,e.y,e.w,e.h))}}drawDugSpotDecor(t){const e=["#875f3c","#6f4a2d","#9b7048"];for(const i of t.dirtDecor){const s=t.x+i.xOffset,a=t.y+i.yOffset,n=i.size,o=i.flipX?-1:1;this.ctx.fillStyle=e[i.shadeIndex%e.length],this.ctx.beginPath(),this.ctx.moveTo(s,a),this.ctx.lineTo(s+o*n,a+1),this.ctx.lineTo(s,a+n),this.ctx.closePath(),this.ctx.fill()}}drawPlatforms(){for(const t of this.currentLevel().platforms){const e=Math.round(t.x),i=Math.round(t.y),s=Math.round(t.w),a=Math.round(t.h);this.ctx.fillStyle="#7e848c",this.ctx.fillRect(e,i,s,a),this.ctx.fillStyle="#9aa1a8",this.ctx.fillRect(e,i,s,2),this.ctx.fillStyle="#5e646c",this.ctx.fillRect(e,i+a-2,s,2),this.ctx.fillStyle="#6b7178";for(let n=e+4;n<e+s-3;n+=10)this.ctx.fillRect(n,i+4,2,1);this.ctx.fillStyle="#aab1b8";for(let n=e+8;n<e+s-2;n+=12)this.ctx.fillRect(n,i+7,1,1)}}drawBones(){for(const t of this.bones)t.active&&(this.ctx.fillStyle="#ffffff",this.ctx.fillRect(t.x,t.y,t.w,t.h),this.ctx.strokeStyle="#d8d8d8",this.ctx.strokeRect(t.x,t.y,t.w,t.h))}drawDigParticles(){for(const t of this.digParticles){const e=L(t.lifeSec/t.maxLifeSec,0,1);this.ctx.fillStyle=`rgba(${t.colorRgb}, ${e.toFixed(3)})`,this.ctx.fillRect(t.x,t.y,t.w,t.h)}}drawBackgroundLayers(){this.ctx.fillStyle=this.currentLevel().backgroundColor,this.ctx.fillRect(0,0,b,M);for(const t of this.preparedBackgroundLayers){if(t.kind==="gradient"){this.ctx.fillStyle=this.skyGradient??this.currentLevel().backgroundColor,this.ctx.fillRect(0,0,b,M);continue}for(const e of t.stamps){const i=Math.round(e.x-this.camera.x*t.parallax),s=Math.round(e.y);if(!(i+e.w<-8||i>b+8))if(t.kind==="treeLine")this.ctx.fillStyle="#4e6f56",this.ctx.fillRect(i,s-e.h,e.w,e.h),this.ctx.fillStyle="#3f5f49",this.ctx.fillRect(i+2,s-e.h+3,Math.max(2,e.w-4),Math.max(2,e.h-6));else if(t.kind==="hills"){this.ctx.fillStyle=e.variant%2===0?"#7ca582":"#739a79";for(let a=0;a<e.h;a+=2){const n=Math.max(4,e.w-a*2),o=i+(e.w-n>>1);this.ctx.fillRect(o,s-e.h+a,n,2)}}else t.kind==="fenceLine"?(this.ctx.fillStyle="#7a6546",this.ctx.fillRect(i,s-e.h,2,e.h),this.ctx.fillRect(i-1,s-e.h+4,5,1)):t.kind==="clouds"&&(this.ctx.fillStyle="rgba(245, 250, 255, 0.85)",this.ctx.fillRect(i,s,e.w,e.h),this.ctx.fillRect(i+2,s-2,Math.max(2,e.w-4),e.h))}}}drawDecorations(t){for(const e of this.activeDecorations){const i=e.depth??"mid";if(i!==t)continue;const s=Mt(e.kind,e.variant??0),a=Ie(i),n=e.x+this.camera.x*(1-a),o=Math.round(n),l=Math.round(e.y-s.h);this.ctx.drawImage(s.image,o,l)}}drawAmbientPollen(){this.ctx.fillStyle="rgba(246, 237, 179, 0.72)";for(const t of this.ambientPollen){const e=Math.round(t.x),i=Math.round(t.y+Math.sin(this.elapsedSec*t.speed+t.phase)*t.amp);this.ctx.fillRect(e,i,t.size,t.size)}}updateAmbientPollen(t){const e=this.currentLevel().width;for(const i of this.ambientPollen)i.x+=i.vx*t,i.x<-12&&(i.x+=e+24)}drawPlayer(){this.ctx.save(),this.invincibleTimerSec>0&&Math.floor(this.nowMs/80)%2===0&&(this.ctx.globalAlpha=.35);const t=this.player.x-4,e=this.player.y-8,i=24,s=24;if(this.player.facing===-1?(this.ctx.translate(t+i,e),this.ctx.scale(-1,1)):this.ctx.translate(t,e),this.playerSpriteReady){const a=this.getCurrentPlayerFrame();this.ctx.drawImage(this.playerSpriteImage,a.x,a.y,a.w,a.h,0,0,i,s)}else this.ctx.fillStyle=this.playerState==="digging"?"#3b4659":"#2f4f6f",this.ctx.fillRect(4,8,this.player.w,this.player.h),this.ctx.fillStyle="#ffffff",this.ctx.fillRect(15,12,2,2);this.ctx.restore()}updatePlayerAnimation(t){const e=this.playerState==="digging"?"digging":this.player.grounded?Math.abs(this.player.vx)>18?"run":"idle":"jump";e!==this.currentPlayerAnimation&&(this.currentPlayerAnimation=e,this.playerAnimationFrameIndex=0,this.playerAnimationFrameElapsed=0);const i=this.playerAnimations[this.currentPlayerAnimation];if(!(i.length<=1))for(this.playerAnimationFrameElapsed+=t;this.playerAnimationFrameElapsed>=i[this.playerAnimationFrameIndex].duration;)this.playerAnimationFrameElapsed-=i[this.playerAnimationFrameIndex].duration,this.playerAnimationFrameIndex<i.length-1?this.playerAnimationFrameIndex+=1:this.playerAnimationFrameIndex=0}getCurrentPlayerFrame(){const t=this.playerAnimations[this.currentPlayerAnimation];return t[this.playerAnimationFrameIndex]??t[0]}drawHud(){this.ctx.fillStyle="rgba(12, 24, 40, 0.72)",this.ctx.fillRect(6,6,174,46),this.ctx.font="10px monospace",this.ctx.fillStyle="#f7f3c5",this.ctx.fillText("HP",11,18);for(let t=0;t<z;t+=1){const e=30+t*16,i=t<this.hearts;this.ctx.fillStyle=i?"#da4f5d":"#4b5968",this.ctx.fillRect(e,10,10,10),this.ctx.strokeStyle="#81252f",this.ctx.strokeRect(e,10,10,10)}this.ctx.fillStyle="#f7f3c5",this.ctx.fillText(`Bones: ${this.bonesCollected}`,11,31),this.ctx.fillText(`Toy: ${this.hasGoldenToy?"1/1":"0/1"}`,11,44)}drawGateHint(){this.ctx.fillStyle="rgba(0, 0, 0, 0.6)",this.ctx.fillRect(96,8,128,18),this.ctx.fillStyle="#f9e7b8",this.ctx.font="9px monospace",this.ctx.fillText("Find the Golden Toy",105,20)}drawLevelTitle(){const t=L(this.levelTitleTimerSec/1.5,0,1);this.ctx.fillStyle=`rgba(10, 15, 25, ${(.62*t).toFixed(3)})`,this.ctx.fillRect(88,28,144,24),this.ctx.fillStyle=`rgba(246, 240, 214, ${t.toFixed(3)})`,this.ctx.font="10px monospace",this.ctx.fillText(this.currentLevel().name,96,43)}drawDebug(){const t=Math.max(0,dt-(this.nowMs-this.lastGroundedTimeMs)),e=Math.max(0,ut-(this.nowMs-this.lastJumpPressedTimeMs));this.ctx.fillStyle="rgba(0, 0, 0, 0.65)",this.ctx.fillRect(6,56,206,86),this.ctx.fillStyle="#d7f3ff",this.ctx.font="9px monospace",this.ctx.fillText(`GS:${this.gameState} G:${this.player.grounded?1:0} H:${this.hearts} B:${this.bonesCollected}`,10,68),this.ctx.fillText(`Toy:${this.hasGoldenToy?1:0} CamX:${this.camera.x.toFixed(1)}`,10,80),this.ctx.fillText(`State:${this.playerState} DigT:${Math.max(0,this.digTimerSec).toFixed(2)}`,10,92),this.ctx.fillText(`VX:${this.player.vx.toFixed(1)} VY:${this.player.vy.toFixed(1)}`,10,104),this.ctx.fillText(`Coyote:${t.toFixed(0)}ms`,10,116),this.ctx.fillText(`Buffer:${e.toFixed(0)}ms`,10,128)}checkGrounded(){const t={x:this.player.x,y:this.player.y+1,w:this.player.w,h:this.player.h};return this.currentLevel().platforms.some(e=>x(t,e,E))}updateCamera(){const t=Math.max(0,this.currentLevel().width-b),e=this.player.x-$t;this.camera.x=Math.round(L(e,0,t)),this.camera.y=0}prepareBackgroundLayers(t){if(!t.backgroundLayers||t.backgroundLayers.length===0)return[];const e=[];for(const i of t.backgroundLayers){const s=H(`${t.id}:${i.kind}:${i.seed??0}`),a=[];if(i.kind==="treeLine"){let n=-80;for(;n<t.width+140;){const o=22+Math.floor(s()*26),l=12+Math.floor(s()*14);a.push({x:n,y:i.y??146,w:o,h:l,variant:Math.floor(s()*2)}),n+=16+Math.floor(s()*24)}}else if(i.kind==="hills"){let n=-90;for(;n<t.width+180;){const o=46+Math.floor(s()*34),l=12+Math.floor(s()*10);a.push({x:n,y:i.y??157,w:o,h:l,variant:Math.floor(s()*3)}),n+=44+Math.floor(s()*28)}}else if(i.kind==="fenceLine"){let n=-10;for(;n<t.width+30;){const o=6+Math.floor(s()*4);a.push({x:n,y:i.y??160,w:2,h:o,variant:0}),n+=10+Math.floor(s()*5)}}else if(i.kind==="clouds"){let n=-40;for(;n<t.width+80;){const o=14+Math.floor(s()*14),l=4+Math.floor(s()*4),h=18+Math.floor(s()*28);a.push({x:n,y:h,w:o,h:l,variant:0}),n+=40+Math.floor(s()*60)}}e.push({...i,stamps:a})}return e}prepareDecorations(t){if(!t.decorations||t.decorations.length===0)return[];const e=[{x:J-20,y:122,w:92,h:46},{x:this.exitGate.x-18,y:this.exitGate.y-8,w:this.exitGate.w+36,h:this.exitGate.h+10},{x:this.goldenToy.x-16,y:this.goldenToy.y-16,w:this.goldenToy.w+32,h:this.goldenToy.h+24}],i=[];for(const s of t.decorations){const a=Mt(s.kind,s.variant??0),n={x:s.x,y:s.y-a.h,w:a.w,h:a.h};e.some(c=>x(n,c,0))||t.platforms.some(c=>x(n,c,0))||this.digSpots.some(c=>x(n,c,0))||i.push(s)}return i}createAmbientPollen(t){const e=H(`${t.id}:ambient-pollen`),i=[];for(let s=0;s<me;s+=1)i.push({x:Math.floor(e()*t.width),y:pe+Math.floor((e()-.5)*36),vx:-8-e()*8,phase:e()*Math.PI*2,amp:1+e()*2,speed:.8+e(),size:e()<.5?1:2});return i}currentLevel(){return _[this.levelIndex]}resizeCanvas(){const t=window.innerWidth-24,e=window.innerHeight-150,i=Math.max(1,Math.floor(Math.min(t/b,e/M)));this.canvas.style.width=`${b*i}px`,this.canvas.style.height=`${M*i}px`}}function x(r,t,e){return r.x+e<t.x+t.w&&r.x+r.w-e>t.x&&r.y+e<t.y+t.h&&r.y+r.h-e>t.y}function Le(r,t){const e={x:r.x+2,y:r.y+r.h,w:Math.max(1,r.w-4),h:3};return t.some(s=>s.y<160&&x(r,s,0))?!1:t.some(s=>s.y>=160&&x(e,s,0))}function Pe(r){let t=r[0];for(const e of r)e.y>t.y&&(t=e);return t}function H(r){let t=2166136261;for(let e=0;e<r.length;e+=1)t^=r.charCodeAt(e),t=Math.imul(t,16777619);return De(t>>>0)}function Ae(r){const t=H(r),e=3+Math.floor(t()*3),i=[];for(let s=0;s<e;s+=1){const a=s%2===0;i.push({xOffset:a?1+Math.floor(t()*4):B-2-Math.floor(t()*4),yOffset:1+Math.floor(t()*4),size:2+Math.floor(t()*3),shadeIndex:Math.floor(t()*3),flipX:!a})}return i}function De(r){return()=>{let t=r+=1831565813;return t=Math.imul(t^t>>>15,t|1),t^=t+Math.imul(t^t>>>7,t|61),((t^t>>>14)>>>0)/4294967296}}function L(r,t,e){return Math.min(e,Math.max(t,r))}function O(r,t,e){return r+(t-r)*e}function Rt(r,t,e){return Math.abs(t-r)<=e?t:r+Math.sign(t-r)*e}const Et=new Map;function Ie(r){return r==="far"?.9:r==="near"?1.04:1}function Mt(r,t){const e=`${r}:${t}`,i=Et.get(e);if(i)return i;const s=_e(r,t);return Et.set(e,s),s}function _e(r,t){const e=(n,o)=>{const l=document.createElement("canvas");l.width=n,l.height=o;const h=l.getContext("2d");if(!h)throw new Error("Unable to create decoration sprite");return{canvas:l,ctx:h}};if(r==="grass"||r==="weed"){const{canvas:n,ctx:o}=e(6,6),l=r==="weed"?"#3b5d33":"#477543",h=r==="weed"?"#4b7a3f":"#67a35e";return o.fillStyle=l,o.fillRect(2,3,1,3),o.fillRect(3,2,1,4),o.fillStyle=h,o.fillRect(1,4,1,2),o.fillRect(4,4,1,2),t%2===1&&(o.fillRect(0,5,1,1),o.fillRect(5,5,1,1)),{image:n,w:n.width,h:n.height}}if(r==="flower"){const{canvas:n,ctx:o}=e(6,7),l=["#f3d995","#e8b4c3","#f2e7b2"][t%3];return o.fillStyle="#477543",o.fillRect(2,3,1,4),o.fillStyle=l,o.fillRect(1,1,3,2),o.fillStyle="#f0e2a6",o.fillRect(2,2,1,1),{image:n,w:n.width,h:n.height}}if(r==="bush"){const{canvas:n,ctx:o}=e(14,9),l=t%2===0?"#3f663f":"#426b46";return o.fillStyle=l,o.fillRect(2,3,10,6),o.fillRect(0,5,5,4),o.fillRect(9,5,5,4),o.fillStyle="#5d8a5e",o.fillRect(3,4,8,3),{image:n,w:n.width,h:n.height}}if(r==="rock"){const{canvas:n,ctx:o}=e(8,5);return o.fillStyle=t%2===0?"#6b6d74":"#787980",o.fillRect(1,1,6,4),o.fillStyle="#8a8b91",o.fillRect(2,2,2,1),{image:n,w:n.width,h:n.height}}if(r==="fencePost"){const{canvas:n,ctx:o}=e(8,12),l=t%2===0?"#806446":"#735b3f";return o.fillStyle=l,o.fillRect(3,1,2,11),o.fillRect(1,4,6,1),t%2===1&&o.fillRect(0,8,6,1),{image:n,w:n.width,h:n.height}}if(r==="mushroom"){const{canvas:n,ctx:o}=e(7,7);return o.fillStyle="#8f513a",o.fillRect(1,1,5,3),o.fillStyle="#eadab7",o.fillRect(3,4,1,3),{image:n,w:n.width,h:n.height}}const{canvas:i,ctx:s}=e(6,12),a=t%2===0?"#3d6338":"#3f6e41";return s.fillStyle=a,s.fillRect(2,0,1,12),s.fillRect(1,3,2,1),s.fillRect(2,6,2,1),s.fillRect(1,9,2,1),{image:i,w:i.width,h:i.height}}function Ge(){const i=document.createElement("canvas");i.width=96,i.height=72;const s=i.getContext("2d");if(!s)throw new Error("Unable to create placeholder sprite sheet");const a=(h,c,d)=>{const u=h*24,m=c*24;s.clearRect(u,m,24,24);const p="#1b1513",T="#2a1d1a",g="#3a2a22",C="#5a3e2f",R="#d8bf92",I="#f0dfbe",W="#7f5b38",Ot=d==="runA"||d==="runB"||d==="runC"||d==="runD",Nt=d==="digA"||d==="digB",Bt=d==="jump",X=d==="idleB",S=u+11,w=m+(X?6:7),f=u+7,y=m+(Ot?11:12),V=d==="runA"||d==="runD"?-1:d==="runB"||d==="runC"?0:X?-1:0,$=d==="runC"?-1:0;s.fillStyle=p,s.fillRect(u+3+$,m+8+V,4,7),s.fillStyle=C,s.fillRect(u+4+$,m+8+V,3,6),s.fillStyle=R,s.fillRect(u+4+$,m+8+V,2,2),s.fillStyle=p,s.fillRect(f,y,12,8),s.fillStyle=g,s.fillRect(f+1,y,10,7),s.fillStyle=C,s.fillRect(f+2,y+3,8,4),s.fillStyle=p,s.fillRect(S,w,9,8),s.fillStyle=g,s.fillRect(S+1,w+1,7,6);const st=X?-1:0;s.fillStyle=p,s.fillRect(S+1,w-2+st,2,2),s.fillRect(S+6,w-3,2,3),s.fillStyle=R,s.fillRect(S+2,w-1+st,1,1),s.fillRect(S+6,w-1,1,1),s.fillStyle=T,s.fillRect(S+3,w+2,5,4),s.fillStyle=R,s.fillRect(S+4,w+1,1,1),s.fillRect(S+6,w+1,1,1),s.fillRect(S+6,w+4,2,2),s.fillStyle=I,s.fillRect(S+6,w+3,1,1),s.fillStyle=R,s.fillRect(f+8,y+5,4,3),s.fillStyle=I,s.fillRect(f+9,y+5,2,2),s.fillStyle=p,d==="runA"?(s.fillRect(f+1,y+7,2,2),s.fillRect(f+7,y+6,2,3)):d==="runB"?(s.fillRect(f+2,y+6,2,3),s.fillRect(f+8,y+7,2,2)):d==="runC"?(s.fillRect(f+1,y+6,2,3),s.fillRect(f+8,y+7,2,2)):d==="runD"?(s.fillRect(f+2,y+7,2,2),s.fillRect(f+7,y+6,2,3)):Bt?(s.fillRect(f+2,y+6,2,2),s.fillRect(f+8,y+6,2,2)):Nt?(s.fillRect(f+2,y+7,2,2),s.fillRect(f+8,y+7,2,2),s.fillStyle=W,s.fillRect(u+5,m+20,14,3),d==="digB"&&(s.fillRect(u+4,m+19,2,2),s.fillRect(u+18,m+19,2,2))):(s.fillRect(f+2,y+7,2,2),s.fillRect(f+8,y+7,2,2))};a(0,0,"idleA"),a(1,0,"idleB"),a(2,0,"idleA"),a(3,0,"idleB"),a(0,1,"runA"),a(1,1,"runB"),a(2,1,"runC"),a(3,1,"runD"),a(0,2,"jump"),a(1,2,"digA"),a(2,2,"digB"),a(3,2,"idleA");const n=(h,c,d)=>({x:h*24,y:c*24,w:24,h:24,duration:d}),o={idle:[n(0,0,.16),n(1,0,.16),n(2,0,.16),n(3,0,.16)],run:[n(0,1,.1),n(1,1,.1),n(2,1,.1),n(3,1,.1)],jump:[n(0,2,.2)],digging:[n(1,2,.12),n(2,2,.12)]},l=new Image;return l.src=i.toDataURL("image/png"),{image:l,animations:o}}const Ct={ArrowLeft:"left",ArrowRight:"right",ArrowDown:"dig",Space:"jumpHeld"},ke=["left","right","jump","dig"];class Oe{state={left:!1,right:!1,jumpHeld:!1,jumpPressed:!1,dig:!1,digPressed:!1};hasConsumedJump=!1;hasConsumedDig=!1;attachKeyboard(t){t.addEventListener("keydown",e=>{const i=Ct[e.code];if(i){if(e.preventDefault(),i==="jumpHeld"){this.state.jumpHeld||(this.state.jumpPressed=!0),this.state.jumpHeld=!0;return}if(i==="dig"){this.state.dig||(this.state.digPressed=!0),this.state.dig=!0;return}this.state[i]=!0}}),t.addEventListener("keyup",e=>{const i=Ct[e.code];if(i){if(e.preventDefault(),i==="jumpHeld"){this.state.jumpHeld=!1;return}if(i==="dig"){this.state.dig=!1;return}this.state[i]=!1}})}attachTouchButtons(t){t.forEach(e=>{const i=e.dataset.control;if(!i||!ke.includes(i))return;const s=i,a=o=>{if(o.preventDefault(),s==="jump"){this.state.jumpHeld||(this.state.jumpPressed=!0),this.state.jumpHeld=!0;return}s==="left"&&(this.state.left=!0),s==="right"&&(this.state.right=!0),s==="dig"&&(this.state.dig||(this.state.digPressed=!0),this.state.dig=!0)},n=o=>{if(o.preventDefault(),s==="jump"){this.state.jumpHeld=!1;return}s==="left"&&(this.state.left=!1),s==="right"&&(this.state.right=!1),s==="dig"&&(this.state.dig=!1)};e.addEventListener("pointerdown",a),e.addEventListener("pointerup",n),e.addEventListener("pointerleave",n),e.addEventListener("pointercancel",n),e.addEventListener("contextmenu",o=>o.preventDefault())})}consumeJumpPressed(){return this.hasConsumedJump||!this.state.jumpPressed?!1:(this.hasConsumedJump=!0,!0)}consumeDigPressed(){return this.hasConsumedDig||!this.state.digPressed?!1:(this.hasConsumedDig=!0,!0)}endFrame(){this.state.jumpPressed=!1,this.state.digPressed=!1,this.hasConsumedJump=!1,this.hasConsumedDig=!1}}const Ne=108,Z=60/Ne,K=Z/2,Q=8,Be=8,He=Q*Be,Ye=.24,Fe=25,qe=[[48,52,55],[48,52,55],[45,48,52],[45,48,52],[41,45,48],[41,45,48],[43,47,50],[43,47,50]],We=[{step:0,note:72,lengthSteps:2},{step:2,note:76,lengthSteps:2},{step:4,note:79,lengthSteps:2},{step:6,note:76,lengthSteps:2},{step:8,note:74,lengthSteps:2},{step:10,note:76,lengthSteps:2},{step:12,note:79,lengthSteps:3},{step:15,note:81,lengthSteps:1},{step:16,note:72,lengthSteps:2},{step:18,note:69,lengthSteps:2},{step:20,note:72,lengthSteps:2},{step:22,note:76,lengthSteps:2},{step:24,note:74,lengthSteps:2},{step:26,note:72,lengthSteps:2},{step:28,note:69,lengthSteps:3},{step:31,note:67,lengthSteps:1},{step:32,note:65,lengthSteps:2},{step:34,note:69,lengthSteps:2},{step:36,note:72,lengthSteps:2},{step:38,note:69,lengthSteps:2},{step:40,note:67,lengthSteps:2},{step:42,note:69,lengthSteps:2},{step:44,note:72,lengthSteps:3},{step:47,note:74,lengthSteps:1},{step:48,note:67,lengthSteps:2},{step:50,note:71,lengthSteps:2},{step:52,note:74,lengthSteps:2},{step:54,note:71,lengthSteps:2},{step:56,note:69,lengthSteps:2},{step:58,note:67,lengthSteps:2},{step:60,note:64,lengthSteps:2},{step:62,note:71,lengthSteps:2}];class Xe{audioContext=null;masterGain=null;sfxGain=null;musicGain=null;melodyDelay=null;melodyFeedback=null;melodyDelayMix=null;enabled=!0;unlockAttached=!1;musicPlaying=!1;schedulerId=null;nextStepTime=0;nextStepIndex=0;constructor(){this.attachUnlockListeners()}isEnabled(){return this.enabled}setEnabled(t){this.enabled=t,this.masterGain&&this.audioContext&&this.masterGain.gain.setValueAtTime(t?.22:0,this.audioContext.currentTime)}async unlock(){this.ensureContext(),this.audioContext&&this.audioContext.state==="suspended"&&await this.audioContext.resume()}startMusic(){this.ensureContext(),!(!this.audioContext||this.musicPlaying)&&(this.musicPlaying=!0,this.nextStepIndex=0,this.nextStepTime=this.audioContext.currentTime+.05,this.schedulerId=window.setInterval(()=>{this.scheduleMusic()},Fe))}stopMusic(){this.musicPlaying=!1,this.schedulerId!==null&&(window.clearInterval(this.schedulerId),this.schedulerId=null)}playJump(){this.createTone({frequency:500,sweepToFrequency:650,type:"square",duration:.12,volume:.11})}playStomp(){this.createTone({frequency:220,type:"square",duration:.1,volume:.12})}playDig(){this.createTone({frequency:180,sweepToFrequency:120,type:"triangle",duration:.08,volume:.09})}playBonePickup(){this.createTone({frequency:800,type:"square",duration:.1,volume:.1})}playGoldenToyPickup(){const t=this.getNow();this.createTone({frequency:700,type:"square",duration:.15,volume:.1},t),this.createTone({frequency:900,type:"square",duration:.15,volume:.1},t+.16)}playHurt(){this.createTone({frequency:300,sweepToFrequency:100,type:"sawtooth",duration:.2,volume:.12})}playGateUnlock(){this.createTone({frequency:400,sweepToFrequency:600,type:"triangle",duration:.2,volume:.1})}playLevelComplete(){const t=this.getNow();this.createTone({frequency:600,type:"square",duration:.11,volume:.11},t),this.createTone({frequency:800,type:"square",duration:.11,volume:.11},t+.13),this.createTone({frequency:1e3,type:"square",duration:.14,volume:.11},t+.26)}scheduleMusic(){if(!(!this.audioContext||!this.musicPlaying))for(;this.nextStepTime<this.audioContext.currentTime+Ye;)this.scheduleStep(this.nextStepIndex,this.nextStepTime),this.nextStepIndex=(this.nextStepIndex+1)%He,this.nextStepTime+=K}scheduleStep(t,e){if(!this.audioContext||!this.musicGain)return;const i=Math.floor(t/Q),s=t%Q,a=qe[i];s===0&&this.scheduleVoice({frequency:N(a[0]-12),type:"triangle",start:e,duration:Z*.95,volume:.07,attack:.008,release:.08,destination:this.musicGain}),s===4&&this.scheduleVoice({frequency:N(a[2]-12),type:"triangle",start:e,duration:Z*.9,volume:.06,attack:.008,release:.08,destination:this.musicGain});const o=[0,1,2,1,0,1,2,1][s];this.scheduleVoice({frequency:N(a[o]+12),type:"square",start:e,duration:K*.78,volume:.03,attack:.005,release:.04,destination:this.musicGain});for(const l of We){if(l.step!==t)continue;const h=l.lengthSteps*K*.92;this.scheduleMelodyVoice(N(l.note),e,h)}}scheduleMelodyVoice(t,e,i){!this.musicGain||!this.melodyDelayMix||(this.scheduleVoice({frequency:t,type:"square",start:e,duration:i,volume:.055,attack:.01,release:.1,destination:this.musicGain}),this.scheduleVoice({frequency:t,type:"square",start:e,duration:i,volume:.02,attack:.01,release:.1,destination:this.melodyDelayMix}))}getNow(){return this.ensureContext(),this.audioContext?this.audioContext.currentTime:0}createTone(t,e){if(this.ensureContext(),!this.audioContext||!this.sfxGain||!this.enabled)return;const i=e??this.audioContext.currentTime,s=this.audioContext.createOscillator(),a=this.audioContext.createGain();s.type=t.type,s.frequency.setValueAtTime(t.frequency,i),typeof t.sweepToFrequency=="number"&&s.frequency.linearRampToValueAtTime(t.sweepToFrequency,i+t.duration),a.gain.setValueAtTime(0,i),a.gain.linearRampToValueAtTime(t.volume,i+.01),a.gain.linearRampToValueAtTime(1e-4,i+t.duration),s.connect(a),a.connect(this.sfxGain),s.start(i),s.stop(i+t.duration+.02)}scheduleVoice(t){if(!this.audioContext)return;const e=this.audioContext.createOscillator(),i=this.audioContext.createGain();e.type=t.type,e.frequency.setValueAtTime(t.frequency,t.start);const s=Math.max(t.start+t.attack,t.start+t.duration-t.release);i.gain.setValueAtTime(0,t.start),i.gain.linearRampToValueAtTime(t.volume,t.start+t.attack),i.gain.setValueAtTime(t.volume,s),i.gain.linearRampToValueAtTime(1e-4,t.start+t.duration),e.connect(i),i.connect(t.destination),e.start(t.start),e.stop(t.start+t.duration+.02)}ensureContext(){if(this.audioContext)return;const t=window.AudioContext||window.webkitAudioContext;t&&(this.audioContext=new t,this.masterGain=this.audioContext.createGain(),this.sfxGain=this.audioContext.createGain(),this.musicGain=this.audioContext.createGain(),this.melodyDelay=this.audioContext.createDelay(.25),this.melodyFeedback=this.audioContext.createGain(),this.melodyDelayMix=this.audioContext.createGain(),this.masterGain.gain.value=this.enabled?.22:0,this.sfxGain.gain.value=1,this.musicGain.gain.value=.49,this.melodyDelay.delayTime.value=.15,this.melodyFeedback.gain.value=.2,this.melodyDelayMix.gain.value=1,this.sfxGain.connect(this.masterGain),this.musicGain.connect(this.masterGain),this.melodyDelayMix.connect(this.melodyDelay),this.melodyDelay.connect(this.melodyFeedback),this.melodyFeedback.connect(this.melodyDelay),this.melodyDelay.connect(this.musicGain),this.masterGain.connect(this.audioContext.destination))}attachUnlockListeners(){if(this.unlockAttached)return;this.unlockAttached=!0;const t=async()=>{await this.unlock(),this.audioContext&&this.audioContext.state==="running"&&(window.removeEventListener("pointerdown",t),window.removeEventListener("touchstart",t),window.removeEventListener("keydown",t))};window.addEventListener("pointerdown",t),window.addEventListener("touchstart",t),window.addEventListener("keydown",t)}}function N(r){return 440*Math.pow(2,(r-69)/12)}const bt=document.querySelector("#app");if(!bt)throw new Error("Missing #app container");bt.innerHTML=`
  <header class="top-bar">
    <h1>Sisu: Guardian of the Garden</h1>
    <button id="soundToggle" type="button" aria-pressed="true">Sound: On</button>
  </header>
  <main class="game-shell">
    <canvas id="gameCanvas" width="320" height="180" aria-label="Game canvas"></canvas>
    <div id="startOverlay" class="start-overlay">
      <div class="start-card">
        <h2>Sisu: Guardian of the Garden</h2>
        <p>Phase 5 Prototype</p>
        <button id="startButton" type="button">Start</button>
      </div>
    </div>
    <div id="gameOverOverlay" class="start-overlay hidden">
      <div class="start-card">
        <h2>Game Over</h2>
        <p>Press R or tap restart.</p>
        <button id="restartButton" type="button">Restart</button>
      </div>
    </div>
    <div id="levelCompleteOverlay" class="start-overlay hidden">
      <div class="start-card">
        <h2>Level Complete!</h2>
        <p id="levelStats">Bones: 0 | Hearts: 0 | Time: 0.0s</p>
        <button id="playAgainButton" type="button">Play Again</button>
        <button id="nextLevelButton" type="button">Next Level</button>
      </div>
    </div>
    <div id="demoCompleteOverlay" class="start-overlay hidden">
      <div class="start-card">
        <h2>You Finished the Demo!</h2>
        <p id="demoStats">Thanks for playing Sisu.</p>
        <button id="demoPlayAgainButton" type="button">Play Again</button>
      </div>
    </div>
  </main>
  <footer class="mobile-controls" aria-label="Touch controls">
    <button data-control="left" type="button">Left</button>
    <button data-control="right" type="button">Right</button>
    <button data-control="jump" type="button">Jump</button>
    <button data-control="dig" type="button">Dig</button>
  </footer>
`;const Lt=document.querySelector("#gameCanvas"),Pt=document.querySelector("#startOverlay"),At=document.querySelector("#startButton"),F=document.querySelector("#gameOverOverlay"),Dt=document.querySelector("#restartButton"),D=document.querySelector("#levelCompleteOverlay"),It=document.querySelector("#levelStats"),_t=document.querySelector("#playAgainButton"),tt=document.querySelector("#nextLevelButton"),q=document.querySelector("#demoCompleteOverlay"),Gt=document.querySelector("#demoStats"),kt=document.querySelector("#demoPlayAgainButton"),Y=document.querySelector("#soundToggle"),Ve=Array.from(document.querySelectorAll("[data-control]"));if(!Lt||!Pt||!At||!F||!Dt||!D||!It||!_t||!tt||!q||!Gt||!kt||!Y)throw new Error("Missing required game UI elements");const et=new Oe;et.attachKeyboard(window);et.attachTouchButtons(Ve);const v=new Xe,P=new be(Lt,et,{sound:v,onGameOver:()=>{v.stopMusic(),F.classList.remove("hidden")},onLevelComplete:({bonesCollected:r,heartsRemaining:t,timeSec:e,levelName:i,hasNextLevel:s})=>{v.stopMusic(),It.textContent=`${i} | Bones: ${r} | Hearts: ${t} | Time: ${e.toFixed(1)}s`,tt.textContent=s?"Next Level":"Finish Demo",D.classList.remove("hidden")},onDemoComplete:({bonesCollected:r,heartsRemaining:t,timeSec:e})=>{v.stopMusic(),Gt.textContent=`Total Bones: ${r} | Hearts: ${t} | Time: ${e.toFixed(1)}s`,q.classList.remove("hidden")}}),it=()=>{P.restart(),v.startMusic(),F.classList.add("hidden"),D.classList.add("hidden"),q.classList.add("hidden")},$e=()=>{P.restartFromFirstLevel(),v.startMusic(),F.classList.add("hidden"),D.classList.add("hidden"),q.classList.add("hidden")};let A=!0;Y.addEventListener("click",()=>{v.unlock(),A=!A,v.setEnabled(A),Y.textContent=`Sound: ${A?"On":"Off"}`,Y.setAttribute("aria-pressed",String(A))});At.addEventListener("click",()=>{v.unlock(),Pt.classList.add("hidden"),P.start(),v.startMusic()});Dt.addEventListener("click",it);_t.addEventListener("click",it);tt.addEventListener("click",()=>{D.classList.add("hidden"),P.nextLevel()&&v.startMusic()});kt.addEventListener("click",$e);window.addEventListener("keydown",r=>{r.code==="KeyR"&&(P.isGameOver()||P.isLevelComplete()||P.isDemoComplete())&&it()});
