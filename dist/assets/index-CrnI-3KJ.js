(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))i(s);new MutationObserver(s=>{for(const n of s)if(n.type==="childList")for(const o of n.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&i(o)}).observe(document,{childList:!0,subtree:!0});function t(s){const n={};return s.integrity&&(n.integrity=s.integrity),s.referrerPolicy&&(n.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?n.credentials="include":s.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function i(s){if(s.ep)return;s.ep=!0;const n=t(s);fetch(s.href,n)}})();const $=56,ie=.18,He={rat:{width:14,height:12,speed:$,hp:1,baseColor:"#8b2e3b",eyeColor:"#f8d7db"},mouse:{width:11,height:9,speed:$*1.4,hp:1,baseColor:"#8c5a73",eyeColor:"#f9e9f2"},tank:{width:17,height:14,speed:$*.75,hp:2,baseColor:"#4d5f72",eyeColor:"#d8e7f5"}};class Fe{type;maxHp;width;height;speed;baseColor;eyeColor;x;y;vx;vy;facing;grounded=!1;alive=!0;hp;hitStunTimerSec=0;spawnTimerSec=ie;animTimerSec=0;constructor(e){const t=He[e.type];this.type=e.type,this.maxHp=t.hp,this.width=t.width,this.height=t.height,this.speed=t.speed,this.baseColor=t.baseColor,this.eyeColor=t.eyeColor,this.x=e.x,this.y=e.y,this.facing=e.facing??-1,this.vx=this.speed*this.facing,this.vy=0,this.hp=this.maxHp}update(e,t,i,s,n){if(!this.alive)return;this.hitStunTimerSec>0&&(this.hitStunTimerSec=Math.max(0,this.hitStunTimerSec-e)),this.spawnTimerSec>0&&(this.spawnTimerSec=Math.max(0,this.spawnTimerSec-e)),this.animTimerSec+=e;const o=this.hitStunTimerSec<=0;if(o&&this.grounded&&!this.hasGroundAhead(t)&&this.reverseDirection(),this.vx=o?this.speed*this.facing:0,this.x+=this.vx*e,o){let a=!1;for(const l of t)ne(this.getBody(),l,n)&&(a=!0,this.vx>0?this.x=l.x-this.width+n:this.vx<0&&(this.x=l.x+l.w-n));a&&(this.reverseDirection(),this.vx=this.speed*this.facing)}this.vy=Math.min(this.vy+i*e,s),this.y+=this.vy*e,this.grounded=!1;for(const a of t)ne(this.getBody(),a,n)&&(this.vy>0?(this.y=a.y-this.height+n,this.grounded=!0):this.vy<0&&(this.y=a.y+a.h-n),this.vy=0)}draw(e){if(!this.alive)return;const t=this.getBody(),i=this.spawnTimerSec>0?.8+(1-this.spawnTimerSec/ie)*.2:1,s=t.x+t.w/2,n=t.y+t.h,o=t.w*i,a=t.h*i,l=s-o/2,h=n-a,d=Be(this.type),c=Math.floor(this.animTimerSec/d.frameDuration)%2,u=this.type==="tank"&&this.hp===1?1:0;if(d.image.complete&&d.image.naturalWidth>0){const m=c*d.frameW,p=u*d.frameH;e.save(),this.facing===-1?(e.translate(l+o,h),e.scale(-1,1),e.drawImage(d.image,m,p,d.frameW,d.frameH,0,0,o,a)):e.drawImage(d.image,m,p,d.frameW,d.frameH,l,h,o,a),e.restore();return}e.save(),e.fillStyle=this.baseColor,e.fillRect(l,h,o,a),e.fillStyle=this.eyeColor,e.fillRect(l+o-3,h+3,2,2),e.restore()}canDamagePlayer(){return this.alive&&this.hitStunTimerSec<=0&&this.spawnTimerSec<=0}applyStomp(){return this.alive?(this.hp-=1,this.hitStunTimerSec=.2,this.hp<=0?(this.alive=!1,this.vx=0,this.vy=0,"killed"):"damaged"):"killed"}isAlive(){return this.alive}getBody(){return{x:this.x,y:this.y,w:this.width,h:this.height}}hasGroundAhead(e){const t=this.facing===1?this.x+this.width+2:this.x-2,i=this.y+this.height+2;return e.some(s=>{const n=t>=s.x&&t<=s.x+s.w,o=i>=s.y&&i<=s.y+s.h+1;return n&&o})}reverseDirection(){this.facing=this.facing===1?-1:1}}function se(r,e,t,i=-1){return new Fe({type:r,x:e,y:t,facing:i})}function ne(r,e,t){return r.x+t<e.x+e.w&&r.x+r.w-t>e.x&&r.y+t<e.y+e.h&&r.y+r.h-t>e.y}function Be(r){return U||(U=Ye()),U[r]}let U=null;function Ye(){return{rat:ke(),mouse:qe(),tank:We()}}function ke(){const t=document.createElement("canvas");t.width=40,t.height=14;const i=t.getContext("2d");if(!i)throw new Error("Unable to create rat sprite");const s=o=>{const a=o*20,l="#2f2420",h="#5c4639",d="#7c604b",c="#d8595b",u="#a78176";i.fillStyle=u,i.fillRect(a+1,8,5,1),i.fillRect(a+0,9,3,1),i.fillStyle=l,i.fillRect(a+5,5,11,6),i.fillRect(a+14,4,4,4),i.fillStyle=h,i.fillRect(a+6,6,9,4),i.fillRect(a+14,5,3,2),i.fillStyle=d,i.fillRect(a+8,7,5,2),i.fillStyle=l,i.fillRect(a+15,3,1,1),i.fillStyle=c,i.fillRect(a+16,6,1,1),i.fillStyle=l,o===0?(i.fillRect(a+7,11,2,2),i.fillRect(a+12,10,2,3)):(i.fillRect(a+8,10,2,3),i.fillRect(a+12,11,2,2))};s(0),s(1);const n=new Image;return n.src=t.toDataURL("image/png"),{image:n,frameW:20,frameH:14,frameDuration:.12}}function qe(){const t=document.createElement("canvas");t.width=32,t.height=12;const i=t.getContext("2d");if(!i)throw new Error("Unable to create mouse sprite");const s=o=>{const a=o*16,l="#493744",h="#8c6f82",d="#d2a8bf",c="#ff8088",u="#cfafba";i.fillStyle=u,i.fillRect(a+0,7,4,1),i.fillStyle=l,i.fillRect(a+4,5,8,4),i.fillRect(a+10,4,3,3),i.fillStyle=h,i.fillRect(a+5,6,6,2),i.fillStyle=d,i.fillRect(a+9,2,2,2),i.fillRect(a+11,2,2,2),i.fillStyle=c,i.fillRect(a+11,5,1,1),i.fillStyle=l,o===0?(i.fillRect(a+5,9,1,2),i.fillRect(a+9,8,1,3)):(i.fillRect(a+6,8,1,3),i.fillRect(a+9,9,1,2))};s(0),s(1);const n=new Image;return n.src=t.toDataURL("image/png"),{image:n,frameW:16,frameH:12,frameDuration:.08}}function We(){const t=document.createElement("canvas");t.width=44,t.height=32;const i=t.getContext("2d");if(!i)throw new Error("Unable to create tank sprite");const s=(o,a)=>{const l=o*22,h=a?16:0,d="#2d3a48",c="#526475",u="#9caec2",m="#deeffa",p="#6f8397";i.fillStyle=p,i.fillRect(l+1,h+9,5,1),i.fillStyle=d,i.fillRect(l+5,h+6,13,7),i.fillRect(l+15,h+5,4,4),i.fillStyle=c,i.fillRect(l+6,h+7,11,5),i.fillStyle=u,i.fillRect(l+6,h+8,11,2),a&&(i.fillStyle="#263443",i.fillRect(l+11,h+8,1,2),i.fillRect(l+12,h+9,1,1),i.fillRect(l+10,h+9,1,1)),i.fillStyle=m,i.fillRect(l+17,h+7,1,1),i.fillStyle=d,o===0?(i.fillRect(l+7,h+13,2,2),i.fillRect(l+13,h+12,2,3)):(i.fillRect(l+8,h+12,2,3),i.fillRect(l+13,h+13,2,2))};s(0,!1),s(1,!1),s(0,!0),s(1,!0);const n=new Image;return n.src=t.toDataURL("image/png"),{image:n,frameW:22,frameH:16,frameDuration:.14}}const L=320,P=180,Xe=L*.4,oe=1200,Ve=900,$e=650,ae=170,Ue=.65,re=1200,le=700,he=120,ce=120,R=.75,de=2,j=3,je=1,ue=190,ze=4,Je=.5,ye=3,Ke=6,F=16,fe=6,Ze=.1,Qe=28,et=34,tt=28,it=.7,me=.3,st=-120,nt=520,ot=2.5,pe=.45,at=.2,rt=.35,lt=.075,ht=600,ge=30,ct=8,dt=12,ut="170, 142, 104",yt=1.5,xe=16,Se=40,ft={id:"wild-garden",name:"Wild Garden",width:2200,height:P,backgroundColor:"#8bd3ff",platforms:[{x:0,y:164,w:2200,h:16},{x:70,y:132,w:86,h:10},{x:220,y:110,w:72,h:10},{x:390,y:136,w:92,h:10},{x:540,y:102,w:74,h:10},{x:700,y:126,w:84,h:10},{x:890,y:98,w:80,h:10},{x:1080,y:136,w:96,h:10},{x:1260,y:108,w:78,h:10},{x:1450,y:124,w:90,h:10},{x:1640,y:96,w:82,h:10},{x:1830,y:130,w:94,h:10},{x:2010,y:112,w:72,h:10}],enemySpawnPoints:[{x:120,groundY:132},{x:430,groundY:136},{x:740,groundY:126},{x:1120,groundY:136},{x:1500,groundY:124},{x:1860,groundY:130}],goldenToyPosition:{x:1560,y:82},exitGatePosition:{x:2080,y:132},digSeed:"wild-garden-seed"},mt={id:"courtyard",name:"Courtyard",width:2200,height:P,backgroundColor:"#d9dde2",platforms:[{x:0,y:164,w:2200,h:16},{x:40,y:144,w:70,h:10},{x:150,y:122,w:62,h:10},{x:250,y:100,w:54,h:10},{x:350,y:132,w:72,h:10},{x:500,y:112,w:58,h:10},{x:620,y:90,w:54,h:10},{x:760,y:124,w:70,h:10},{x:920,y:102,w:56,h:10},{x:1040,y:82,w:54,h:10},{x:1180,y:126,w:72,h:10},{x:1360,y:106,w:60,h:10},{x:1500,y:86,w:54,h:10},{x:1650,y:122,w:74,h:10},{x:1830,y:100,w:60,h:10},{x:1980,y:124,w:76,h:10}],enemySpawnPoints:[{x:70,groundY:144},{x:390,groundY:132},{x:800,groundY:124},{x:1210,groundY:126},{x:1690,groundY:122},{x:2020,groundY:124}],goldenToyPosition:{x:1700,y:74},exitGatePosition:{x:2080,y:132},digSeed:"courtyard-seed"},pt={id:"snow-garden",name:"Snow Garden",width:2200,height:P,backgroundColor:"#b7d4ef",platforms:[{x:0,y:164,w:2200,h:16},{x:70,y:132,w:86,h:10},{x:220,y:110,w:72,h:10},{x:390,y:136,w:92,h:10},{x:540,y:102,w:74,h:10},{x:700,y:126,w:84,h:10},{x:890,y:98,w:80,h:10},{x:1080,y:136,w:96,h:10},{x:1260,y:108,w:78,h:10},{x:1450,y:124,w:90,h:10},{x:1640,y:96,w:82,h:10},{x:1830,y:130,w:94,h:10},{x:2010,y:112,w:72,h:10}],enemySpawnPoints:[{x:120,groundY:132},{x:430,groundY:136},{x:740,groundY:126},{x:1120,groundY:136},{x:1500,groundY:124},{x:1860,groundY:130}],goldenToyPosition:{x:1640,y:84},exitGatePosition:{x:2080,y:132},digSeed:"snow-garden-seed"},D=[ft,mt,pt],gt=[{type:"rat",weight:.5},{type:"mouse",weight:.3},{type:"tank",weight:.2}],xt=3,we=6,ve=10,St=2,wt=3,vt=120,Tt=22,G={w:8,h:8},O={w:18,h:32};class Et{canvas;ctx;input;onGameOver;onLevelComplete;onDemoComplete;sound;enemies=[];playerSpriteImage;playerAnimations;playerSpriteReady=!1;currentPlayerAnimation="idle";playerAnimationFrameIndex=0;playerAnimationFrameElapsed=0;lastTick=0;nowMs=0;isRunning=!1;lastGroundedTimeMs=-1/0;lastJumpPressedTimeMs=-1/0;previousJumpHeld=!1;debugEnabled=!1;hearts=j;bonesCollected=0;invincibleTimerSec=0;gameState="playing";elapsedSec=0;levelIndex=0;levelTitleTimerSec=0;camera={x:0,y:0};playerState="normal";digTimerSec=0;activeDigSpotIndex=null;digSpots=[];bones=[];digParticles=[];digEmitTimerSec=0;goldenToy={x:0,y:0,w:G.w,h:G.h,collected:!1};exitGate={x:0,y:0,w:O.w,h:O.h};hasGoldenToy=!1;gateHintTimerSec=0;spawnTimerSec=0;pendingRespawnTimers=[];player={x:xe,y:Se,w:16,h:16,vx:0,vy:0,facing:1,grounded:!1,animationTime:0};constructor(e,t,i={}){const s=e.getContext("2d");if(!s)throw new Error("2D context unavailable");this.canvas=e,this.ctx=s,this.input=t,this.onGameOver=i.onGameOver,this.onLevelComplete=i.onLevelComplete,this.onDemoComplete=i.onDemoComplete,this.sound=i.sound,this.loadLevel(0);const n=bt();this.playerSpriteImage=n.image,this.playerAnimations=n.animations,this.playerSpriteImage.onload=()=>{this.playerSpriteReady=!0},this.ctx.imageSmoothingEnabled=!1,window.addEventListener("keydown",o=>{o.code==="Backslash"&&(this.debugEnabled=!this.debugEnabled)}),this.resizeCanvas(),window.addEventListener("resize",()=>this.resizeCanvas())}start(){this.isRunning||(this.isRunning=!0,this.lastTick=performance.now(),requestAnimationFrame(e=>this.loop(e)))}restart(){this.loadLevel(this.levelIndex)}restartFromFirstLevel(){this.loadLevel(0)}nextLevel(){return this.levelIndex+1>=D.length?(this.gameState="demoComplete",this.onDemoComplete?.({bonesCollected:this.bonesCollected,heartsRemaining:this.hearts,timeSec:this.elapsedSec,levelName:this.currentLevel().name}),!1):(this.loadLevel(this.levelIndex+1),!0)}isDemoComplete(){return this.gameState==="demoComplete"}getCurrentLevelName(){return this.currentLevel().name}hasNextLevel(){return this.levelIndex+1<D.length}loadLevel(e){this.levelIndex=M(e,0,D.length-1),this.hearts=j,this.bonesCollected=0,this.invincibleTimerSec=0,this.gameState="playing",this.lastGroundedTimeMs=-1/0,this.lastJumpPressedTimeMs=-1/0,this.previousJumpHeld=!1,this.elapsedSec=0,this.playerState="normal",this.digTimerSec=0,this.activeDigSpotIndex=null,this.digEmitTimerSec=0,this.player.x=xe,this.player.y=Se,this.player.vx=0,this.player.vy=0,this.player.facing=1,this.player.grounded=!1,this.player.animationTime=0,this.currentPlayerAnimation="idle",this.playerAnimationFrameIndex=0,this.playerAnimationFrameElapsed=0,this.resetEnemyWave(),this.digSpots=this.generateDigSpots(this.currentLevel().digSeed),this.bones=[],this.digParticles=[],this.goldenToy={x:this.currentLevel().goldenToyPosition.x,y:this.currentLevel().goldenToyPosition.y,w:G.w,h:G.h,collected:!1},this.exitGate={x:this.currentLevel().exitGatePosition.x,y:this.currentLevel().exitGatePosition.y,w:O.w,h:O.h},this.hasGoldenToy=!1,this.gateHintTimerSec=0,this.levelTitleTimerSec=1.5,this.camera.x=0,this.camera.y=0}isGameOver(){return this.gameState==="gameOver"}isLevelComplete(){return this.gameState==="levelComplete"}loop(e){if(!this.isRunning)return;const t=Math.min((e-this.lastTick)/1e3,1/30);this.lastTick=e,this.nowMs=e,this.update(t),this.render(),this.input.endFrame(),requestAnimationFrame(i=>this.loop(i))}update(e){if(this.gameState!=="playing")return;const t=this.input.state,i=Number(t.right)-Number(t.left),s=this.player.y+this.player.h;if(this.elapsedSec+=e,this.invincibleTimerSec>0&&(this.invincibleTimerSec=Math.max(0,this.invincibleTimerSec-e)),this.gateHintTimerSec>0&&(this.gateHintTimerSec=Math.max(0,this.gateHintTimerSec-e)),this.levelTitleTimerSec>0&&(this.levelTitleTimerSec=Math.max(0,this.levelTitleTimerSec-e)),this.playerState==="normal"&&this.input.consumeDigPressed()){const n=this.findDigSpotForPlayer();this.player.grounded&&n!==null&&(this.playerState="digging",this.digTimerSec=Je,this.activeDigSpotIndex=n,this.player.vx=0)}if(this.player.grounded&&(this.lastGroundedTimeMs=this.nowMs),this.playerState==="normal"){this.input.consumeJumpPressed()&&(this.lastJumpPressedTimeMs=this.nowMs),i<0?this.player.facing=-1:i>0&&(this.player.facing=1);const n=this.player.grounded?Ve:$e;i!==0?this.player.vx+=i*n*e:this.player.grounded&&(this.player.vx=Te(this.player.vx,0,re*e)),this.player.vx=M(this.player.vx,-ae,ae);const o=this.nowMs-this.lastJumpPressedTimeMs<=ce,a=this.player.grounded||this.nowMs-this.lastGroundedTimeMs<=he;o&&a&&(this.player.vy=-420,this.player.grounded=!1,this.lastJumpPressedTimeMs=-1/0,this.lastGroundedTimeMs=-1/0,this.sound?.playJump()),this.previousJumpHeld&&!t.jumpHeld&&this.player.vy<0&&(this.player.vy*=Ue)}else this.player.grounded&&(this.player.vx=Te(this.player.vx,0,re*e)),this.emitDigParticlesWhileDigging(e),this.digTimerSec-=e,this.digTimerSec<=0&&this.finishDig();this.player.vy+=oe*e,this.player.vy=Math.min(this.player.vy,le),this.moveHorizontal(e,t),this.clampPlayerToWorldBounds(),this.moveVertical(e),this.player.grounded=this.checkGrounded(),this.player.grounded&&(this.lastGroundedTimeMs=this.nowMs),this.updateEnemySpawning(e);for(const n of this.enemies)n.update(e,this.currentLevel().platforms,oe,le,R);this.handlePlayerEnemyCollision(s),this.updateBonesAndParticles(e),this.handleGoldenToyAndGate(),this.updateCamera(),this.updatePlayerAnimation(e),this.player.animationTime+=e,this.previousJumpHeld=t.jumpHeld}moveHorizontal(e,t){this.player.x+=this.player.vx*e;for(const i of this.currentLevel().platforms)x(this.player,i,R)&&(this.tryStepUp(t)||(this.player.vx>0&&this.player.x+this.player.w>i.x?this.player.x=i.x-this.player.w+R:this.player.vx<0&&(this.player.x=i.x+i.w-R),this.player.vx=0))}moveVertical(e){this.player.y+=this.player.vy*e;for(const t of this.currentLevel().platforms)x(this.player,t,R)&&(this.player.vy>0?this.player.y=t.y-this.player.h+R:this.player.vy<0&&(this.player.y=t.y+t.h-R),this.player.vy=0)}clampPlayerToWorldBounds(){const e=this.currentLevel().width-this.player.w;this.player.x<0?(this.player.x=0,this.player.vx=Math.max(0,this.player.vx)):this.player.x>e&&(this.player.x=e,this.player.vx=Math.min(0,this.player.vx))}tryStepUp(e){const t=e.right&&this.player.vx>0||e.left&&this.player.vx<0;if(!this.player.grounded||!t)return!1;const i={x:this.player.x,y:this.player.y-de,w:this.player.w,h:this.player.h};return this.currentLevel().platforms.some(n=>x(i,n,R))?!1:(this.player.y-=de,!0)}handlePlayerEnemyCollision(e){for(let t=this.enemies.length-1;t>=0;t-=1){const i=this.enemies[t];if(!i.isAlive())continue;const s=i.getBody();if(!x(this.player,s,0))continue;const n=this.player.y+this.player.h;if(this.player.vy>0&&e<=s.y+ze&&n>=s.y){const h=i.applyStomp();this.player.vy=-189,this.player.grounded=!1,this.lastGroundedTimeMs=-1/0,this.sound?.playStomp(),h==="killed"&&(this.enemies.splice(t,1),this.pendingRespawnTimers.push(this.randomRange(St,wt)));return}if(this.invincibleTimerSec>0||!i.canDamagePlayer())continue;this.hearts=Math.max(0,this.hearts-1),this.invincibleTimerSec=je;const a=this.player.x+this.player.w/2,l=s.x+s.w/2;this.player.vx=a<l?-ue:ue,this.player.vy=-220,this.player.grounded=!1,this.sound?.playHurt(),this.hearts<=0&&(this.gameState="gameOver",this.onGameOver?.());return}}resetEnemyWave(){this.enemies=[],this.pendingRespawnTimers=[],this.spawnTimerSec=this.randomRange(we,ve),this.spawnEnemyIfPossible()}updateEnemySpawning(e){this.spawnTimerSec-=e,this.spawnTimerSec<=0&&(this.spawnEnemyIfPossible(),this.spawnTimerSec=this.randomRange(we,ve));for(let t=this.pendingRespawnTimers.length-1;t>=0;t-=1)this.pendingRespawnTimers[t]-=e,this.pendingRespawnTimers[t]<=0&&(this.spawnEnemyIfPossible()?this.pendingRespawnTimers.splice(t,1):this.pendingRespawnTimers[t]=1)}spawnEnemyIfPossible(){if(this.enemies.length>=xt)return!1;const e=this.pickEnemyType(),i=se(e,0,0).getBody(),s=this.player.x+this.player.w/2,n=[...this.currentLevel().enemySpawnPoints].sort(()=>Math.random()-.5);for(const o of n){const a=o.x,l=o.groundY-i.h-.01,h={x:a,y:l,w:i.w,h:i.h},d=a+h.w/2;if(Math.abs(d-s)<vt||this.enemies.some(g=>{const C=g.getBody(),E=C.x+C.w/2;return Math.abs(E-d)<Tt})||this.currentLevel().platforms.some(g=>x(h,g,0))||!this.currentLevel().platforms.some(g=>{const C=h.x+h.w/2,E=h.y+h.h+2,_=C>=g.x&&C<=g.x+g.w,q=E>=g.y&&E<=g.y+g.h+2;return _&&q}))continue;const p=d>s?-1:1,T=se(e,h.x,h.y,p);return this.enemies.push(T),this.emitEnemySpawnPoof(T.getBody()),!0}return!1}pickEnemyType(){const e=Math.random();let t=0;for(const i of gt)if(t+=i.weight,e<=t)return i.type;return"rat"}randomRange(e,t){return e+Math.random()*(t-e)}emitEnemySpawnPoof(e){const t=Math.floor(this.randomRange(ct,dt+1)),i=e.x+e.w/2,s=e.y+e.h-2;for(let n=0;n<t;n+=1){const o=Math.random()*Math.PI*2,a=this.randomRange(22,70),l=Math.random()<.5?2:3,h=this.randomRange(.25,.35);this.pushDigParticle({x:i+Math.cos(o)*2,y:s+Math.sin(o)*1.5,w:l,h:l,vx:M(Math.cos(o)*a,-60,60),vy:M(Math.sin(o)*a-80,-120,-40),lifeSec:h,maxLifeSec:h,colorRgb:ut})}}handleGoldenToyAndGate(){if(!this.goldenToy.collected&&x(this.player,this.goldenToy,0)&&(this.goldenToy.collected=!0,this.hasGoldenToy=!0,this.sound?.playGoldenToyPickup(),this.sound?.playGateUnlock()),!!x(this.player,this.exitGate,0)){if(!this.hasGoldenToy){this.gateHintTimerSec=Math.max(this.gateHintTimerSec,yt);return}this.gameState="levelComplete",this.sound?.playLevelComplete(),this.onLevelComplete?.({bonesCollected:this.bonesCollected,heartsRemaining:this.hearts,timeSec:this.elapsedSec,levelName:this.currentLevel().name,hasNextLevel:this.hasNextLevel()})}}updateBonesAndParticles(e){for(const t of this.bones)t.active&&(t.state==="popping"&&(t.popTimerSec+=e,t.vy+=nt*e,t.y+=t.vy*e,t.popTimerSec<me*.75?t.y=Math.max(t.targetY,t.y):t.y=Math.min(t.settleY,Math.max(t.targetY,t.y)),t.popTimerSec>=me&&(t.state="idle",t.y=t.settleY,t.vy=0)),t.state==="idle"&&x(this.player,t,0)&&(t.active=!1,this.bonesCollected+=1,this.sound?.playBonePickup()));for(let t=this.digParticles.length-1;t>=0;t-=1){const i=this.digParticles[t];if(i.lifeSec-=e,i.lifeSec<=0){this.digParticles.splice(t,1);continue}i.x+=i.vx*e,i.y+=i.vy*e,i.vy+=ht*e}}finishDig(){if(this.playerState="normal",this.sound?.playDig(),this.activeDigSpotIndex===null)return;const e=this.digSpots[this.activeDigSpotIndex];this.activeDigSpotIndex=null,!(!e||e.dug)&&(e.dug=!0,e.hasBone?this.spawnBoneFromSpot(e):this.spawnEmptyDigPuff(e))}spawnBoneFromSpot(e){const s=e.y+e.h,n=s-4,o=s-12,a=o+ot;this.bones.push({x:e.x+(e.w-8)/2,y:n,w:8,h:6,active:!0,vy:st,state:"popping",popTimerSec:0,startY:n,targetY:o,settleY:a})}spawnEmptyDigPuff(e){const t=e.x+e.w/2,i=e.y+1,s=3+Math.floor((e.x+e.y)%4);for(let n=0;n<s;n+=1){const o=n-(s-1)/2;this.pushDigParticle({x:t+o*2,y:i,w:3,h:3,vx:o*16,vy:-45-Math.abs(o)*5,lifeSec:pe,maxLifeSec:pe,colorRgb:"120, 78, 42"})}}emitDigParticlesWhileDigging(e){if(this.activeDigSpotIndex===null)return;const t=this.digSpots[this.activeDigSpotIndex];if(t)for(this.digEmitTimerSec-=e;this.digEmitTimerSec<=0;){this.digEmitTimerSec+=lt;const i=1+Math.floor(Math.random()*2);for(let s=0;s<i;s+=1){const n=Math.random()<.5?2:3,o=N(at,rt,Math.random());this.pushDigParticle({x:t.x+t.w*(.25+Math.random()*.5),y:t.y+t.h-1,w:n,h:n,vx:N(-40,40,Math.random()),vy:N(-120,-60,Math.random()),lifeSec:o,maxLifeSec:o,colorRgb:"120, 78, 42"})}}}pushDigParticle(e){this.digParticles.push(e),this.digParticles.length>ge&&this.digParticles.splice(0,this.digParticles.length-ge)}findDigSpotForPlayer(){for(let e=0;e<this.digSpots.length;e+=1){const t=this.digSpots[e];if(!t.dug&&x(this.player,t,0))return e}return null}generateDigSpots(e){const t=Ct(this.currentLevel().platforms),i=Re(e),s=ye+Math.floor(i()*(Ke-ye+1)),n=Math.max(t.x+Math.floor(this.currentLevel().width*Ze),t.x+Qe),o=t.x+t.w-F-2,a=[];let l=0;for(;a.length<s&&l<300;){l+=1;const h=Math.floor(N(n,o,i())),d=h+F/2;if(this.currentLevel().enemySpawnPoints.some(T=>Math.abs(d-T.x)<et)||a.some(T=>Math.abs(d-(T.x+T.w/2))<tt))continue;const m=t.y-fe,p={x:h,y:m,w:F,h:fe,dug:!1,hasBone:i()<it,dirtDecor:Mt(`${e}:${h}:${m}`)};Rt(p,this.currentLevel().platforms)&&a.push(p)}return a}render(){this.ctx.imageSmoothingEnabled=!1,this.ctx.clearRect(0,0,L,P),this.ctx.fillStyle=this.currentLevel().backgroundColor,this.ctx.fillRect(0,0,L,P),this.ctx.save(),this.ctx.translate(-this.camera.x,-this.camera.y),this.ctx.fillStyle="#669f5d";for(const e of this.currentLevel().platforms)this.ctx.fillRect(e.x,e.y,e.w,e.h);this.drawExitGate(),this.drawGoldenToy(),this.drawDigSpots(),this.drawBones(),this.drawDigParticles();for(const e of this.enemies)e.draw(this.ctx);this.drawPlayer(),this.ctx.restore(),this.drawHud(),this.gateHintTimerSec>0&&this.drawGateHint(),this.levelTitleTimerSec>0&&this.drawLevelTitle(),this.debugEnabled&&this.drawDebug()}drawExitGate(){const e=this.hasGoldenToy,t=.75+Math.sin(this.nowMs*.01)*.25;this.ctx.fillStyle=e?`rgba(76, 178, 89, ${t.toFixed(3)})`:"#6d5f67",this.ctx.fillRect(this.exitGate.x,this.exitGate.y,this.exitGate.w,this.exitGate.h),this.ctx.fillStyle=e?"#c8f3ce":"#a99ca4";const i=3;for(let s=0;s<i;s+=1){const n=this.exitGate.x+3+s*4;this.ctx.fillRect(n,this.exitGate.y+3,2,this.exitGate.h-6)}this.ctx.strokeStyle="#283040",this.ctx.strokeRect(this.exitGate.x,this.exitGate.y,this.exitGate.w,this.exitGate.h)}drawGoldenToy(){if(this.goldenToy.collected)return;const e=1+Math.sin(this.nowMs*.012)*.1,t=this.goldenToy.w*e,i=this.goldenToy.h*e,s=this.goldenToy.x-(t-this.goldenToy.w)/2,n=this.goldenToy.y-(i-this.goldenToy.h)/2;this.ctx.fillStyle="#f5cb42",this.ctx.fillRect(s,n,t,i),this.ctx.fillStyle="#fff2b8",this.ctx.fillRect(s+2,n+2,Math.max(1,t-4),Math.max(1,i-4)),this.ctx.strokeStyle="#a87f18",this.ctx.strokeRect(s,n,t,i)}drawDigSpots(){for(let e=0;e<this.digSpots.length;e+=1){const t=this.digSpots[e],i=this.activeDigSpotIndex===e&&this.playerState==="digging";this.ctx.fillStyle=t.dug?"#8b7657":"#56724a",this.ctx.fillRect(t.x,t.y,t.w,t.h),t.dug?(this.ctx.fillStyle="#3f3c34",this.ctx.fillRect(t.x+2,t.y+2,t.w-4,2),this.drawDugSpotDecor(t)):(this.ctx.fillStyle=i?"#d7c086":"#8ca574",this.ctx.fillRect(t.x+2,t.y+1,2,2),this.ctx.fillRect(t.x+t.w-4,t.y+1,2,2)),this.debugEnabled&&(this.ctx.strokeStyle="rgba(255, 255, 0, 0.8)",this.ctx.strokeRect(t.x,t.y,t.w,t.h))}}drawDugSpotDecor(e){const t=["#7f6948","#6f5b3f","#8d7450"];for(const i of e.dirtDecor){const s=e.x+i.xOffset,n=e.y+i.yOffset,o=i.size,a=i.flipX?-1:1;this.ctx.fillStyle=t[i.shadeIndex%t.length],this.ctx.beginPath(),this.ctx.moveTo(s,n),this.ctx.lineTo(s+a*o,n+1),this.ctx.lineTo(s,n+o),this.ctx.closePath(),this.ctx.fill()}}drawBones(){for(const e of this.bones)e.active&&(this.ctx.fillStyle="#ffffff",this.ctx.fillRect(e.x,e.y,e.w,e.h),this.ctx.strokeStyle="#d8d8d8",this.ctx.strokeRect(e.x,e.y,e.w,e.h))}drawDigParticles(){for(const e of this.digParticles){const t=M(e.lifeSec/e.maxLifeSec,0,1);this.ctx.fillStyle=`rgba(${e.colorRgb}, ${t.toFixed(3)})`,this.ctx.fillRect(e.x,e.y,e.w,e.h)}}drawPlayer(){this.ctx.save(),this.invincibleTimerSec>0&&Math.floor(this.nowMs/80)%2===0&&(this.ctx.globalAlpha=.35);const e=this.player.x-4,t=this.player.y-8,i=24,s=24;if(this.player.facing===-1?(this.ctx.translate(e+i,t),this.ctx.scale(-1,1)):this.ctx.translate(e,t),this.playerSpriteReady){const n=this.getCurrentPlayerFrame();this.ctx.drawImage(this.playerSpriteImage,n.x,n.y,n.w,n.h,0,0,i,s)}else this.ctx.fillStyle=this.playerState==="digging"?"#3b4659":"#2f4f6f",this.ctx.fillRect(4,8,this.player.w,this.player.h),this.ctx.fillStyle="#ffffff",this.ctx.fillRect(15,12,2,2);this.ctx.restore()}updatePlayerAnimation(e){const t=this.playerState==="digging"?"digging":this.player.grounded?Math.abs(this.player.vx)>18?"run":"idle":"jump";t!==this.currentPlayerAnimation&&(this.currentPlayerAnimation=t,this.playerAnimationFrameIndex=0,this.playerAnimationFrameElapsed=0);const i=this.playerAnimations[this.currentPlayerAnimation];if(!(i.length<=1))for(this.playerAnimationFrameElapsed+=e;this.playerAnimationFrameElapsed>=i[this.playerAnimationFrameIndex].duration;)this.playerAnimationFrameElapsed-=i[this.playerAnimationFrameIndex].duration,this.playerAnimationFrameIndex<i.length-1?this.playerAnimationFrameIndex+=1:this.playerAnimationFrameIndex=0}getCurrentPlayerFrame(){const e=this.playerAnimations[this.currentPlayerAnimation];return e[this.playerAnimationFrameIndex]??e[0]}drawHud(){this.ctx.fillStyle="rgba(12, 24, 40, 0.72)",this.ctx.fillRect(6,6,174,46),this.ctx.font="10px monospace",this.ctx.fillStyle="#f7f3c5",this.ctx.fillText("HP",11,18);for(let e=0;e<j;e+=1){const t=30+e*16,i=e<this.hearts;this.ctx.fillStyle=i?"#da4f5d":"#4b5968",this.ctx.fillRect(t,10,10,10),this.ctx.strokeStyle="#81252f",this.ctx.strokeRect(t,10,10,10)}this.ctx.fillStyle="#f7f3c5",this.ctx.fillText(`Bones: ${this.bonesCollected}`,11,31),this.ctx.fillText(`Toy: ${this.hasGoldenToy?"1/1":"0/1"}`,11,44)}drawGateHint(){this.ctx.fillStyle="rgba(0, 0, 0, 0.6)",this.ctx.fillRect(96,8,128,18),this.ctx.fillStyle="#f9e7b8",this.ctx.font="9px monospace",this.ctx.fillText("Find the Golden Toy",105,20)}drawLevelTitle(){const e=M(this.levelTitleTimerSec/1.5,0,1);this.ctx.fillStyle=`rgba(10, 15, 25, ${(.62*e).toFixed(3)})`,this.ctx.fillRect(88,28,144,24),this.ctx.fillStyle=`rgba(246, 240, 214, ${e.toFixed(3)})`,this.ctx.font="10px monospace",this.ctx.fillText(this.currentLevel().name,96,43)}drawDebug(){const e=Math.max(0,he-(this.nowMs-this.lastGroundedTimeMs)),t=Math.max(0,ce-(this.nowMs-this.lastJumpPressedTimeMs));this.ctx.fillStyle="rgba(0, 0, 0, 0.65)",this.ctx.fillRect(6,56,206,86),this.ctx.fillStyle="#d7f3ff",this.ctx.font="9px monospace",this.ctx.fillText(`GS:${this.gameState} G:${this.player.grounded?1:0} H:${this.hearts} B:${this.bonesCollected}`,10,68),this.ctx.fillText(`Toy:${this.hasGoldenToy?1:0} CamX:${this.camera.x.toFixed(1)}`,10,80),this.ctx.fillText(`State:${this.playerState} DigT:${Math.max(0,this.digTimerSec).toFixed(2)}`,10,92),this.ctx.fillText(`VX:${this.player.vx.toFixed(1)} VY:${this.player.vy.toFixed(1)}`,10,104),this.ctx.fillText(`Coyote:${e.toFixed(0)}ms`,10,116),this.ctx.fillText(`Buffer:${t.toFixed(0)}ms`,10,128)}checkGrounded(){const e={x:this.player.x,y:this.player.y+1,w:this.player.w,h:this.player.h};return this.currentLevel().platforms.some(t=>x(e,t,R))}updateCamera(){const e=Math.max(0,this.currentLevel().width-L),t=this.player.x-Xe;this.camera.x=M(t,0,e),this.camera.y=0}currentLevel(){return D[this.levelIndex]}resizeCanvas(){const e=window.innerWidth-24,t=window.innerHeight-150,i=Math.max(1,Math.floor(Math.min(e/L,t/P)));this.canvas.style.width=`${L*i}px`,this.canvas.style.height=`${P*i}px`}}function x(r,e,t){return r.x+t<e.x+e.w&&r.x+r.w-t>e.x&&r.y+t<e.y+e.h&&r.y+r.h-t>e.y}function Rt(r,e){const t={x:r.x+2,y:r.y+r.h,w:Math.max(1,r.w-4),h:3};return e.some(s=>s.y<160&&x(r,s,0))?!1:e.some(s=>s.y>=160&&x(t,s,0))}function Ct(r){let e=r[0];for(const t of r)t.y>e.y&&(e=t);return e}function Re(r){let e=2166136261;for(let t=0;t<r.length;t+=1)e^=r.charCodeAt(t),e=Math.imul(e,16777619);return Pt(e>>>0)}function Mt(r){const e=Re(r),t=3+Math.floor(e()*3),i=[];for(let s=0;s<t;s+=1){const n=s%2===0;i.push({xOffset:n?1+Math.floor(e()*4):F-2-Math.floor(e()*4),yOffset:1+Math.floor(e()*4),size:2+Math.floor(e()*3),shadeIndex:Math.floor(e()*3),flipX:!n})}return i}function Pt(r){return()=>{let e=r+=1831565813;return e=Math.imul(e^e>>>15,e|1),e^=e+Math.imul(e^e>>>7,e|61),((e^e>>>14)>>>0)/4294967296}}function M(r,e,t){return Math.min(t,Math.max(e,r))}function N(r,e,t){return r+(e-r)*t}function Te(r,e,t){return Math.abs(e-r)<=t?e:r+Math.sign(e-r)*t}function bt(){const i=document.createElement("canvas");i.width=96,i.height=72;const s=i.getContext("2d");if(!s)throw new Error("Unable to create placeholder sprite sheet");const n=(h,d,c)=>{const u=h*24,m=d*24;s.clearRect(u,m,24,24);const p="#1b1513",T="#2a1d1a",g="#3a2a22",C="#5a3e2f",E="#d8bf92",_="#f0dfbe",q="#7f5b38",Ge=c==="runA"||c==="runB"||c==="runC"||c==="runD",Oe=c==="digA"||c==="digB",Ne=c==="jump",W=c==="idleB",S=u+11,w=m+(W?6:7),y=u+7,f=m+(Ge?11:12),X=c==="runA"||c==="runD"?-1:c==="runB"||c==="runC"?0:W?-1:0,V=c==="runC"?-1:0;s.fillStyle=p,s.fillRect(u+3+V,m+8+X,4,7),s.fillStyle=C,s.fillRect(u+4+V,m+8+X,3,6),s.fillStyle=E,s.fillRect(u+4+V,m+8+X,2,2),s.fillStyle=p,s.fillRect(y,f,12,8),s.fillStyle=g,s.fillRect(y+1,f,10,7),s.fillStyle=C,s.fillRect(y+2,f+3,8,4),s.fillStyle=p,s.fillRect(S,w,9,8),s.fillStyle=g,s.fillRect(S+1,w+1,7,6);const te=W?-1:0;s.fillStyle=p,s.fillRect(S+1,w-2+te,2,2),s.fillRect(S+6,w-3,2,3),s.fillStyle=E,s.fillRect(S+2,w-1+te,1,1),s.fillRect(S+6,w-1,1,1),s.fillStyle=T,s.fillRect(S+3,w+2,5,4),s.fillStyle=E,s.fillRect(S+4,w+1,1,1),s.fillRect(S+6,w+1,1,1),s.fillRect(S+6,w+4,2,2),s.fillStyle=_,s.fillRect(S+6,w+3,1,1),s.fillStyle=E,s.fillRect(y+8,f+5,4,3),s.fillStyle=_,s.fillRect(y+9,f+5,2,2),s.fillStyle=p,c==="runA"?(s.fillRect(y+1,f+7,2,2),s.fillRect(y+7,f+6,2,3)):c==="runB"?(s.fillRect(y+2,f+6,2,3),s.fillRect(y+8,f+7,2,2)):c==="runC"?(s.fillRect(y+1,f+6,2,3),s.fillRect(y+8,f+7,2,2)):c==="runD"?(s.fillRect(y+2,f+7,2,2),s.fillRect(y+7,f+6,2,3)):Ne?(s.fillRect(y+2,f+6,2,2),s.fillRect(y+8,f+6,2,2)):Oe?(s.fillRect(y+2,f+7,2,2),s.fillRect(y+8,f+7,2,2),s.fillStyle=q,s.fillRect(u+5,m+20,14,3),c==="digB"&&(s.fillRect(u+4,m+19,2,2),s.fillRect(u+18,m+19,2,2))):(s.fillRect(y+2,f+7,2,2),s.fillRect(y+8,f+7,2,2))};n(0,0,"idleA"),n(1,0,"idleB"),n(2,0,"idleA"),n(3,0,"idleB"),n(0,1,"runA"),n(1,1,"runB"),n(2,1,"runC"),n(3,1,"runD"),n(0,2,"jump"),n(1,2,"digA"),n(2,2,"digB"),n(3,2,"idleA");const o=(h,d,c)=>({x:h*24,y:d*24,w:24,h:24,duration:c}),a={idle:[o(0,0,.16),o(1,0,.16),o(2,0,.16),o(3,0,.16)],run:[o(0,1,.1),o(1,1,.1),o(2,1,.1),o(3,1,.1)],jump:[o(0,2,.2)],digging:[o(1,2,.12),o(2,2,.12)]},l=new Image;return l.src=i.toDataURL("image/png"),{image:l,animations:a}}const Ee={ArrowLeft:"left",ArrowRight:"right",ArrowDown:"dig",Space:"jumpHeld"},Lt=["left","right","jump","dig"];class At{state={left:!1,right:!1,jumpHeld:!1,jumpPressed:!1,dig:!1,digPressed:!1};hasConsumedJump=!1;hasConsumedDig=!1;attachKeyboard(e){e.addEventListener("keydown",t=>{const i=Ee[t.code];if(i){if(t.preventDefault(),i==="jumpHeld"){this.state.jumpHeld||(this.state.jumpPressed=!0),this.state.jumpHeld=!0;return}if(i==="dig"){this.state.dig||(this.state.digPressed=!0),this.state.dig=!0;return}this.state[i]=!0}}),e.addEventListener("keyup",t=>{const i=Ee[t.code];if(i){if(t.preventDefault(),i==="jumpHeld"){this.state.jumpHeld=!1;return}if(i==="dig"){this.state.dig=!1;return}this.state[i]=!1}})}attachTouchButtons(e){e.forEach(t=>{const i=t.dataset.control;if(!i||!Lt.includes(i))return;const s=i,n=a=>{if(a.preventDefault(),s==="jump"){this.state.jumpHeld||(this.state.jumpPressed=!0),this.state.jumpHeld=!0;return}s==="left"&&(this.state.left=!0),s==="right"&&(this.state.right=!0),s==="dig"&&(this.state.dig||(this.state.digPressed=!0),this.state.dig=!0)},o=a=>{if(a.preventDefault(),s==="jump"){this.state.jumpHeld=!1;return}s==="left"&&(this.state.left=!1),s==="right"&&(this.state.right=!1),s==="dig"&&(this.state.dig=!1)};t.addEventListener("pointerdown",n),t.addEventListener("pointerup",o),t.addEventListener("pointerleave",o),t.addEventListener("pointercancel",o),t.addEventListener("contextmenu",a=>a.preventDefault())})}consumeJumpPressed(){return this.hasConsumedJump||!this.state.jumpPressed?!1:(this.hasConsumedJump=!0,!0)}consumeDigPressed(){return this.hasConsumedDig||!this.state.digPressed?!1:(this.hasConsumedDig=!0,!0)}endFrame(){this.state.jumpPressed=!1,this.state.digPressed=!1,this.hasConsumedJump=!1,this.hasConsumedDig=!1}}const It=108,J=60/It,z=J/2,K=8,_t=8,Dt=K*_t,Gt=.24,Ot=25,Nt=[[48,52,55],[48,52,55],[45,48,52],[45,48,52],[41,45,48],[41,45,48],[43,47,50],[43,47,50]],Ht=[{step:0,note:72,lengthSteps:2},{step:2,note:76,lengthSteps:2},{step:4,note:79,lengthSteps:2},{step:6,note:76,lengthSteps:2},{step:8,note:74,lengthSteps:2},{step:10,note:76,lengthSteps:2},{step:12,note:79,lengthSteps:3},{step:15,note:81,lengthSteps:1},{step:16,note:72,lengthSteps:2},{step:18,note:69,lengthSteps:2},{step:20,note:72,lengthSteps:2},{step:22,note:76,lengthSteps:2},{step:24,note:74,lengthSteps:2},{step:26,note:72,lengthSteps:2},{step:28,note:69,lengthSteps:3},{step:31,note:67,lengthSteps:1},{step:32,note:65,lengthSteps:2},{step:34,note:69,lengthSteps:2},{step:36,note:72,lengthSteps:2},{step:38,note:69,lengthSteps:2},{step:40,note:67,lengthSteps:2},{step:42,note:69,lengthSteps:2},{step:44,note:72,lengthSteps:3},{step:47,note:74,lengthSteps:1},{step:48,note:67,lengthSteps:2},{step:50,note:71,lengthSteps:2},{step:52,note:74,lengthSteps:2},{step:54,note:71,lengthSteps:2},{step:56,note:69,lengthSteps:2},{step:58,note:67,lengthSteps:2},{step:60,note:64,lengthSteps:2},{step:62,note:71,lengthSteps:2}];class Ft{audioContext=null;masterGain=null;sfxGain=null;musicGain=null;melodyDelay=null;melodyFeedback=null;melodyDelayMix=null;enabled=!0;unlockAttached=!1;musicPlaying=!1;schedulerId=null;nextStepTime=0;nextStepIndex=0;constructor(){this.attachUnlockListeners()}isEnabled(){return this.enabled}setEnabled(e){this.enabled=e,this.masterGain&&this.audioContext&&this.masterGain.gain.setValueAtTime(e?.22:0,this.audioContext.currentTime)}async unlock(){this.ensureContext(),this.audioContext&&this.audioContext.state==="suspended"&&await this.audioContext.resume()}startMusic(){this.ensureContext(),!(!this.audioContext||this.musicPlaying)&&(this.musicPlaying=!0,this.nextStepIndex=0,this.nextStepTime=this.audioContext.currentTime+.05,this.schedulerId=window.setInterval(()=>{this.scheduleMusic()},Ot))}stopMusic(){this.musicPlaying=!1,this.schedulerId!==null&&(window.clearInterval(this.schedulerId),this.schedulerId=null)}playJump(){this.createTone({frequency:500,sweepToFrequency:650,type:"square",duration:.12,volume:.11})}playStomp(){this.createTone({frequency:220,type:"square",duration:.1,volume:.12})}playDig(){this.createTone({frequency:180,sweepToFrequency:120,type:"triangle",duration:.08,volume:.09})}playBonePickup(){this.createTone({frequency:800,type:"square",duration:.1,volume:.1})}playGoldenToyPickup(){const e=this.getNow();this.createTone({frequency:700,type:"square",duration:.15,volume:.1},e),this.createTone({frequency:900,type:"square",duration:.15,volume:.1},e+.16)}playHurt(){this.createTone({frequency:300,sweepToFrequency:100,type:"sawtooth",duration:.2,volume:.12})}playGateUnlock(){this.createTone({frequency:400,sweepToFrequency:600,type:"triangle",duration:.2,volume:.1})}playLevelComplete(){const e=this.getNow();this.createTone({frequency:600,type:"square",duration:.11,volume:.11},e),this.createTone({frequency:800,type:"square",duration:.11,volume:.11},e+.13),this.createTone({frequency:1e3,type:"square",duration:.14,volume:.11},e+.26)}scheduleMusic(){if(!(!this.audioContext||!this.musicPlaying))for(;this.nextStepTime<this.audioContext.currentTime+Gt;)this.scheduleStep(this.nextStepIndex,this.nextStepTime),this.nextStepIndex=(this.nextStepIndex+1)%Dt,this.nextStepTime+=z}scheduleStep(e,t){if(!this.audioContext||!this.musicGain)return;const i=Math.floor(e/K),s=e%K,n=Nt[i];s===0&&this.scheduleVoice({frequency:H(n[0]-12),type:"triangle",start:t,duration:J*.95,volume:.07,attack:.008,release:.08,destination:this.musicGain}),s===4&&this.scheduleVoice({frequency:H(n[2]-12),type:"triangle",start:t,duration:J*.9,volume:.06,attack:.008,release:.08,destination:this.musicGain});const a=[0,1,2,1,0,1,2,1][s];this.scheduleVoice({frequency:H(n[a]+12),type:"square",start:t,duration:z*.78,volume:.03,attack:.005,release:.04,destination:this.musicGain});for(const l of Ht){if(l.step!==e)continue;const h=l.lengthSteps*z*.92;this.scheduleMelodyVoice(H(l.note),t,h)}}scheduleMelodyVoice(e,t,i){!this.musicGain||!this.melodyDelayMix||(this.scheduleVoice({frequency:e,type:"square",start:t,duration:i,volume:.055,attack:.01,release:.1,destination:this.musicGain}),this.scheduleVoice({frequency:e,type:"square",start:t,duration:i,volume:.02,attack:.01,release:.1,destination:this.melodyDelayMix}))}getNow(){return this.ensureContext(),this.audioContext?this.audioContext.currentTime:0}createTone(e,t){if(this.ensureContext(),!this.audioContext||!this.sfxGain||!this.enabled)return;const i=t??this.audioContext.currentTime,s=this.audioContext.createOscillator(),n=this.audioContext.createGain();s.type=e.type,s.frequency.setValueAtTime(e.frequency,i),typeof e.sweepToFrequency=="number"&&s.frequency.linearRampToValueAtTime(e.sweepToFrequency,i+e.duration),n.gain.setValueAtTime(0,i),n.gain.linearRampToValueAtTime(e.volume,i+.01),n.gain.linearRampToValueAtTime(1e-4,i+e.duration),s.connect(n),n.connect(this.sfxGain),s.start(i),s.stop(i+e.duration+.02)}scheduleVoice(e){if(!this.audioContext)return;const t=this.audioContext.createOscillator(),i=this.audioContext.createGain();t.type=e.type,t.frequency.setValueAtTime(e.frequency,e.start);const s=Math.max(e.start+e.attack,e.start+e.duration-e.release);i.gain.setValueAtTime(0,e.start),i.gain.linearRampToValueAtTime(e.volume,e.start+e.attack),i.gain.setValueAtTime(e.volume,s),i.gain.linearRampToValueAtTime(1e-4,e.start+e.duration),t.connect(i),i.connect(e.destination),t.start(e.start),t.stop(e.start+e.duration+.02)}ensureContext(){if(this.audioContext)return;const e=window.AudioContext||window.webkitAudioContext;e&&(this.audioContext=new e,this.masterGain=this.audioContext.createGain(),this.sfxGain=this.audioContext.createGain(),this.musicGain=this.audioContext.createGain(),this.melodyDelay=this.audioContext.createDelay(.25),this.melodyFeedback=this.audioContext.createGain(),this.melodyDelayMix=this.audioContext.createGain(),this.masterGain.gain.value=this.enabled?.22:0,this.sfxGain.gain.value=1,this.musicGain.gain.value=.49,this.melodyDelay.delayTime.value=.15,this.melodyFeedback.gain.value=.2,this.melodyDelayMix.gain.value=1,this.sfxGain.connect(this.masterGain),this.musicGain.connect(this.masterGain),this.melodyDelayMix.connect(this.melodyDelay),this.melodyDelay.connect(this.melodyFeedback),this.melodyFeedback.connect(this.melodyDelay),this.melodyDelay.connect(this.musicGain),this.masterGain.connect(this.audioContext.destination))}attachUnlockListeners(){if(this.unlockAttached)return;this.unlockAttached=!0;const e=async()=>{await this.unlock(),this.audioContext&&this.audioContext.state==="running"&&(window.removeEventListener("pointerdown",e),window.removeEventListener("touchstart",e),window.removeEventListener("keydown",e))};window.addEventListener("pointerdown",e),window.addEventListener("touchstart",e),window.addEventListener("keydown",e)}}function H(r){return 440*Math.pow(2,(r-69)/12)}const Ce=document.querySelector("#app");if(!Ce)throw new Error("Missing #app container");Ce.innerHTML=`
  <header class="top-bar">
    <h1>Sisu: Guardian of the Garden</h1>
    <button id="soundToggle" type="button" aria-pressed="true">Sound: On</button>
  </header>
  <main class="game-shell">
    <canvas id="gameCanvas" width="320" height="180" aria-label="Game canvas"></canvas>
    <div id="startOverlay" class="start-overlay">
      <div class="start-card">
        <h2>Sisu: Guardian of the Garden</h2>
        <p>Phase 5 Prototype</p>
        <button id="startButton" type="button">Start</button>
      </div>
    </div>
    <div id="gameOverOverlay" class="start-overlay hidden">
      <div class="start-card">
        <h2>Game Over</h2>
        <p>Press R or tap restart.</p>
        <button id="restartButton" type="button">Restart</button>
      </div>
    </div>
    <div id="levelCompleteOverlay" class="start-overlay hidden">
      <div class="start-card">
        <h2>Level Complete!</h2>
        <p id="levelStats">Bones: 0 | Hearts: 0 | Time: 0.0s</p>
        <button id="playAgainButton" type="button">Play Again</button>
        <button id="nextLevelButton" type="button">Next Level</button>
      </div>
    </div>
    <div id="demoCompleteOverlay" class="start-overlay hidden">
      <div class="start-card">
        <h2>You Finished the Demo!</h2>
        <p id="demoStats">Thanks for playing Sisu.</p>
        <button id="demoPlayAgainButton" type="button">Play Again</button>
      </div>
    </div>
  </main>
  <footer class="mobile-controls" aria-label="Touch controls">
    <button data-control="left" type="button">Left</button>
    <button data-control="right" type="button">Right</button>
    <button data-control="jump" type="button">Jump</button>
    <button data-control="dig" type="button">Dig</button>
  </footer>
`;const Me=document.querySelector("#gameCanvas"),Pe=document.querySelector("#startOverlay"),be=document.querySelector("#startButton"),Y=document.querySelector("#gameOverOverlay"),Le=document.querySelector("#restartButton"),I=document.querySelector("#levelCompleteOverlay"),Ae=document.querySelector("#levelStats"),Ie=document.querySelector("#playAgainButton"),Z=document.querySelector("#nextLevelButton"),k=document.querySelector("#demoCompleteOverlay"),_e=document.querySelector("#demoStats"),De=document.querySelector("#demoPlayAgainButton"),B=document.querySelector("#soundToggle"),Bt=Array.from(document.querySelectorAll("[data-control]"));if(!Me||!Pe||!be||!Y||!Le||!I||!Ae||!Ie||!Z||!k||!_e||!De||!B)throw new Error("Missing required game UI elements");const Q=new At;Q.attachKeyboard(window);Q.attachTouchButtons(Bt);const v=new Ft,b=new Et(Me,Q,{sound:v,onGameOver:()=>{v.stopMusic(),Y.classList.remove("hidden")},onLevelComplete:({bonesCollected:r,heartsRemaining:e,timeSec:t,levelName:i,hasNextLevel:s})=>{v.stopMusic(),Ae.textContent=`${i} | Bones: ${r} | Hearts: ${e} | Time: ${t.toFixed(1)}s`,Z.textContent=s?"Next Level":"Finish Demo",I.classList.remove("hidden")},onDemoComplete:({bonesCollected:r,heartsRemaining:e,timeSec:t})=>{v.stopMusic(),_e.textContent=`Total Bones: ${r} | Hearts: ${e} | Time: ${t.toFixed(1)}s`,k.classList.remove("hidden")}}),ee=()=>{b.restart(),v.startMusic(),Y.classList.add("hidden"),I.classList.add("hidden"),k.classList.add("hidden")},Yt=()=>{b.restartFromFirstLevel(),v.startMusic(),Y.classList.add("hidden"),I.classList.add("hidden"),k.classList.add("hidden")};let A=!0;B.addEventListener("click",()=>{v.unlock(),A=!A,v.setEnabled(A),B.textContent=`Sound: ${A?"On":"Off"}`,B.setAttribute("aria-pressed",String(A))});be.addEventListener("click",()=>{v.unlock(),Pe.classList.add("hidden"),b.start(),v.startMusic()});Le.addEventListener("click",ee);Ie.addEventListener("click",ee);Z.addEventListener("click",()=>{I.classList.add("hidden"),b.nextLevel()&&v.startMusic()});De.addEventListener("click",Yt);window.addEventListener("keydown",r=>{r.code==="KeyR"&&(b.isGameOver()||b.isLevelComplete()||b.isDemoComplete())&&ee()});
